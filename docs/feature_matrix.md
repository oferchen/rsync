# Feature Matrix â€” Rust rsync vs Upstream 3.4.1

The table below enumerates the major capability areas described in the
`Codex Mission Brief` and records the current implementation status in this
repository. Every entry is backed by code that exists today; missing
functionality explicitly calls out the absence of the relevant crate or
binary so documentation never overstates parity.

| Area | Feature | Status | Notes | Source |
|------|---------|--------|-------|--------|
| Protocol | Protocol version constants, selection helpers, and iteration utilities | Implemented | `ProtocolVersion` exposes `SUPPORTED_PROTOCOLS`, range helpers, and mutual selection logic used for negotiation parity. | `crates/protocol/src/version.rs` |
| Protocol | Legacy ASCII daemon greeting parsing (`@RSYNCD:`) | Implemented | Structured parsers cover banners, authentication prompts, and error/warning lines with exhaustive tests. | `crates/protocol/src/legacy/` |
| Protocol | Multiplexed message envelope (MSG_* tags, vectored writes) | Implemented | Envelope encoding/decoding mirrors upstream layouts and is fuzz/property tested. | `crates/protocol/src/envelope.rs`, `crates/protocol/src/multiplex.rs` |
| Protocol | Negotiation prologue sniffing (legacy vs binary) | Implemented | `NegotiationPrologueDetector` and sniffer utilities reconstruct buffered prefixes for replay. | `crates/protocol/src/negotiation/` |
| Protocol | Compatibility flags exchange & varint codec | Implemented | `CompatibilityFlags` models the post-handshake bitfield and reuses the upstream varint encoding for serialization. | `crates/protocol/src/compatibility.rs`, `crates/protocol/src/varint.rs` |
| Transport | Negotiation stream wrappers with prefix replay | Implemented | `NegotiatedStream` preserves the sniffed bytes, exposes `Read`/`BufRead`, returns the underlying reader for continued use, and provides helpers to parse legacy daemon messages/errors/warnings. | `crates/transport/src/negotiation.rs` |
| Transport | Legacy daemon handshake orchestration | Implemented | `daemon::negotiate_legacy_daemon_session` reads the ASCII greeting, selects the mutual protocol, emits the client banner, and returns the replaying stream together with the parsed metadata. | `crates/transport/src/daemon.rs` |
| Checksums | Rolling checksum (`rsum`) implementation | Implemented | Streaming `RollingChecksum` mirrors upstream `sum1`/`sum2` semantics and exposes safe rolling updates. | `crates/checksums/src/rolling.rs` |
| Checksums | Strong digests (MD4/MD5/XXH64) | Implemented | Streaming wrappers over RustCrypto hashes and `xxhash-rust` provide the strong checksum variants negotiated by rsync. | `crates/checksums/src/strong/` |
| Core | Centralised message formatting with role/version trailers | Implemented | `core::message::Message` reproduces upstream `rsync error:`/`rsync warning:` prefixes, normalises source paths to repo-relative form, and appends `[role=3.4.1-rust]` trailers. | `crates/core/src/message.rs` |
| Core | Version metadata and standard banner formatting | Implemented | `version_metadata()` exposes upstream constants and renders the canonical `--version` banner (`oc-rsync  version 3.4.1-rust (revision/build #REV)  protocol version 32`, copyright notice, web site, and build info line `Rust rsync implementation supporting protocol version 32`). | `crates/core/src/version.rs` |
| Logging | Message sinks with newline policy and scratch-buffer reuse | Implemented | `MessageSink` wraps `io::Write`, reuses `MessageScratch`, and mirrors upstream newline handling for diagnostics while providing mapping/flush helpers. | `crates/logging/src/lib.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--compress-level`, `--no-compress`, `--progress`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, `--specials`/`--no-specials`, `--copy-links`/`-L`, `--copy-dirlinks`/`-k`, `--no-copy-links`, and `--out-format`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Remote operands are executed by spawning the system `rsync` binary (`OC_RSYNC_FALLBACK`) until the native delta-transfer engine lands. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Additional filter directives beyond the implemented subset and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--update`/`-u`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--compress-level`, `--no-compress`, `--progress`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, and `--specials`/`--no-specials`, `--copy-links`/`-L`, `--copy-dirlinks`/`-k`, `--no-copy-links`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Remote transfers, additional filter directives beyond the implemented subset, and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--no-compress`, `--compress-level`, `--progress`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, and `--specials`/`--no-specials`, `--copy-links`/`-L`, `--copy-dirlinks`/`-k`, `--no-copy-links`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Remote operands are executed by spawning the system `rsync` binary (`OC_RSYNC_FALLBACK`) until the native delta-transfer engine lands. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Additional filter directives beyond the implemented subset and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--update`/`-u`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--no-compress`, `--progress`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, and `--specials`/`--no-specials`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Remote transfers, additional filter directives beyond the implemented subset, and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--no-compress`, `--progress`, `--no-progress`, `--msgs2stderr`, `--out-format`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, and `--specials`/`--no-specials`, `--copy-links`/`-L`, `--copy-dirlinks`/`-k`, `--no-copy-links`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Remote operands are executed by spawning the system `rsync` binary (`OC_RSYNC_FALLBACK`) until the native delta-transfer engine lands. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Additional filter directives beyond the implemented subset and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Workspace | CLI front-end (`bin/oc-rsync`) | Partial | The binary supports `--help`, `--version`, `--dry-run`, `--archive`/`-a` (implying `--owner`/`--group`/`--devices`/`--specials`), `--delete`, `--delete-after`, `--checksum`/`-c`, `--size-only`, `--ignore-existing`, `--update`/`-u`, `--exclude`, `--exclude-from`, `--include`, `--include-from`, `--filter` with `+`/`-` actions, `show PATTERN`, `hide PATTERN`, `protect PATTERN`, `exclude-if-present=FILE`, and `merge FILE`, `--files-from` with optional `--from0`, `--password-file` (including `--password-file=-` to read from standard input), `--relative`/`-R`, `--owner`, `--group`, `--numeric-ids`/`--no-numeric-ids`, `--bwlimit`, `--timeout`, `--compress`/`-z`, `--no-compress`, `--progress`, `--no-progress`, `--msgs2stderr`, `--stats`, `--partial`/`--no-partial`, `--remove-source-files`/`--remove-sent-files`, `--inplace`/`--no-inplace`, `--acls`/`-A` and `--xattrs`/`--no-xattrs` when the respective features are compiled, `--sparse`, `-D`, `--devices`/`--no-devices`, and `--specials`/`--no-specials`, `--copy-links`/`-L`, `--copy-dirlinks`/`-k`, `--no-copy-links`. It performs deterministic local copies for regular files, directories, symbolic links, FIFOs, and sparse files while preserving permissions, timestamps, optional ownership metadata, device nodes, and (when enabled) extended attributes and POSIX ACLs when the corresponding flags are supplied, and can list modules from `rsync://` daemons using the legacy handshake. Progress output now streams live updates via carriage-return refreshes and `--stats` surfaces the counters tracked by the local copy engine. Remote transfers, additional filter directives beyond the implemented subset, and compression remain unimplemented (the CLI accepts compression toggles for parity but local transfers do not yet compress data). | `crates/cli`, `bin/oc-rsync`, `crates/core/src/client.rs` |
| Transport | Binary negotiation orchestration | Implemented | `binary::negotiate_binary_session` drives the remote-shell handshake, clamps the negotiated protocol, and returns the replaying stream together with the peer advertisement. | `crates/transport/src/binary.rs` |
| Transport | Unified session handshake facade | Implemented | `session::negotiate_session` routes to binary or legacy handshakes, reports negotiated/clamped protocol metadata, and rehydrates sniffers so callers can resume without replaying the transport. | `crates/transport/src/session/handshake.rs` |
| Workspace | Daemon server (`bin/oc-rsyncd`) | Partial | Listens on a configurable TCP socket with explicit IPv4/IPv6 selection via `--ipv4`/`--ipv6`, completes the legacy handshake for sequential connections, advertises active features via `@RSYNCD: CAP â€¦` lines (currently `modules` and `authlist`), serves `#list` requests using modules provided via `--module` or `--config` (subset of `rsyncd.conf`), emits configurable MOTD lines from `--motd-file`/`--motd-line` and global `motd`/`motd file` directives, enforces `hosts allow`/`hosts deny`, validates `auth users` credentials against the configured secrets file using the upstream challenge/response exchange, honours module-level `use chroot` directives (rejecting non-absolute paths when enabled), caps simultaneous connections per module via the `max connections` directive, recognises runtime `--bwlimit`/`--no-bwlimit` toggles, and returns a deterministic `@ERROR` response while full module serving is pending. | `crates/daemon/src/lib.rs` |
| Workspace | Core transfer orchestration plus engine/meta/filter/compress crates | Partial | `core::client::run_client` now delegates to [`LocalCopyPlan`](../crates/engine/src/local_copy.rs) for deterministic local filesystem copies preserving permissions, timestamps, optional owner/group metadata, extended attributes, and (when the feature is enabled) POSIX ACLs, and, when requested, deletes destination entries that are absent from the source. Delta-transfer logic, comprehensive filter merging, compression, and remote transport orchestration remain pending. | `crates/core/src/client.rs`, `crates/engine/src/local_copy.rs`, `crates/meta/src/lib.rs` |
| Workspace | Deterministic filesystem walker | Implemented | `rsync_walk` provides a depth-first iterator that yields lexicographically ordered entries, enforces root-relative paths, and optionally follows directory symlinks while preventing cycles. | `crates/walk/src/lib.rs` |
| Quality | Golden parity harness & interop tests | Missing | The repository does not yet build or execute the upstream rsync comparison matrix. | _n/a_ |
| Quality | Packaging (deb/rpm), SBOM, systemd unit | Partial | `cargo-deb`/`cargo-rpm` metadata install both binaries together with a hardened systemd unit, environment defaults, and a sample configuration; SBOM automation remains pending. | `bin/oc-rsync/Cargo.toml`, `packaging/systemd/oc-rsyncd.service` |

Status legend: **Implemented** â€” behavior is present and backed by tests in this
repository. **Partial** â€” functionality exists but key capabilities are
disabled or incomplete pending follow-up work. **Missing** â€” code has not been
written yet; entries remain until the corresponding crates/binaries land and
parity is verified.
