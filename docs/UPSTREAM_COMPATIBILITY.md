# Upstream rsync Compatibility

This document tracks how oc-rsync implementation mirrors upstream rsync from https://rsync.samba.org.

## General Principles

- Wire protocol compatibility with rsync versions 3.0.9, 3.1.3, and 3.4.1
- Protocol versions 28-32 supported
- Exit codes match upstream rsync semantics
- Error message formats follow upstream conventions (with Rust source location suffix)
- No fallback to system rsync - native implementation throughout

## Batch Mode Format Compatibility

### Upstream rsync Batch File Format

Based on rsync v3.4.1 source code examination (`batch.c`, `io.c`):

```
Offset  | Field               | Type    | Notes
--------|---------------------|---------|------------------------
0x00    | Stream flags        | i32 LE  | Bitmap of active options
0x04    | Protocol version    | i32 LE  | 28-32
0x08    | Compat flags        | varint  | If protocol >= 30
0x0C+   | Checksum seed       | i32 LE  | Random seed
0x10+   | Raw protocol stream | bytes   | File list + delta data
```

### Stream Flags Bitmap

Matching upstream rsync `batch.c` flag positions:

| Bit | Flag                | Option        | Protocol |
|-----|---------------------|---------------|----------|
| 0   | recurse             | -r/--recurse  | 28+      |
| 1   | preserve_uid        | -o/--owner    | 28+      |
| 2   | preserve_gid        | -g/--group    | 28+      |
| 3   | preserve_links      | -l/--links    | 28+      |
| 4   | preserve_devices    | -D/--devices  | 28+      |
| 5   | preserve_hard_links | -H/--hard-links | 28+    |
| 6   | always_checksum     | -c/--checksum | 28+      |
| 7   | xfer_dirs           | -d/--dirs     | 29+      |
| 8   | do_compression      | -z/--compress | 29+      |
| 9   | iconv               | --iconv       | 30+      |
| 10  | preserve_acls       | -A/--acls     | 30+      |
| 11  | preserve_xattrs     | -X/--xattrs   | 30+      |
| 12  | inplace             | --inplace     | 30+      |
| 13  | append              | --append      | 30+      |
| 14  | append_verify       | --append-verify | 30+    |

### Implementation

**File**: `crates/engine/src/batch/format.rs`

```rust
pub struct BatchHeader {
    pub protocol_version: i32,
    pub compat_flags: Option<u64>,
    pub checksum_seed: i32,
    pub stream_flags: BatchFlags,
}

impl BatchHeader {
    pub fn write_to<W: Write>(&self, writer: &mut W) -> io::Result<()> {
        // Matches upstream order from batch.c and io.c
        self.stream_flags.write_to(writer)?;    // Stream flags bitmap
        write_i32(writer, self.protocol_version)?;  // Protocol version
        if let Some(flags) = self.compat_flags {
            write_varint(writer, flags)?;  // Compat flags (protocol >= 30)
        }
        write_i32(writer, self.checksum_seed)?;  // Checksum seed
        Ok(())
    }
}
```

## Protocol Data Stream

After the header, batch files contain the raw rsync protocol stream as it would be sent over the wire:

1. **File List**: Using the same flist protocol encoding
2. **Delta Operations**: As generated by the sender, without additional framing

This design ensures batch files can be replayed by upstream rsync and vice versa.

## Testing Strategy

### Unit Tests
- Format serialization round-trips (`crates/engine/src/batch/tests.rs`)
- Protocol version handling (28, 29, 30, 31, 32)
- Flag bitmap encoding/decoding

### Integration Tests
- Create batch with oc-rsync, replay with upstream rsync
- Create batch with upstream rsync, replay with oc-rsync
- Cross-protocol version compatibility

### Verification
```bash
# Test oc-rsync → upstream rsync
oc-rsync -av --write-batch=mybatch src/ dest/
rsync --read-batch=mybatch final/
diff -r src/ final/

# Test upstream rsync → oc-rsync
rsync -av --write-batch=mybatch src/ dest/
oc-rsync --read-batch=mybatch final/
diff -r src/ final/
```

## Exit Codes

Exit codes match upstream rsync (see `crates/core/src/message/strings.rs` lines 89-131):

| Code | Meaning |
|------|---------|
| 0    | Success |
| 1    | Syntax or usage error |
| 2    | Protocol incompatibility |
| 3    | File selection errors |
| 23   | Partial transfer (most common) |
| 24   | Files vanished (WARNING, not error) |
| ... | (Full list in source) |

## Error Messages

Error messages follow upstream format with Rust source location suffix:

```
rsync: error message text (code N) at path/to/file.rs:123 [role=0.5.0]
```

Roles match upstream: `[sender]`, `[receiver]`, `[generator]`, `[server]`, `[client]`, `[daemon]`

## Protocol Negotiation

Matches upstream rsync negotiation:
- Binary negotiation for protocol 30+
- ASCII `@RSYNCD:` fallback for older clients
- Highest mutual protocol version selected

## Delta Operations

Delta operations use upstream wire format from `generator.c` and `sender.c`:
- Block matching with rolling checksums
- COPY and LITERAL operation encoding
- Checksum algorithms: MD4, MD5, xxHash (based on protocol version)

## File List Encoding

File list encoding matches upstream `flist.c`:
- Path compression (repeated prefix elision)
- Metadata encoding (mode, mtime, size, uid, gid)
- Relative path normalization

## Status

- ✅ Batch file header format matches upstream
- ✅ Exit codes align with upstream
- ✅ Protocol versions 28-32 supported
- ✅ Error message format follows upstream
- ⏳ Full batch replay implementation in progress
- ⏳ Interoperability testing pending

## References

- Upstream rsync: https://rsync.samba.org
- Source repository: https://github.com/RsyncProject/rsync
- Target version: 3.4.1
- Protocol documentation: https://rsync.samba.org/tech_report/
