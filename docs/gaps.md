# Implementation Gaps

This document tracks the parity status of the Rust rsync workspace. Each entry reflects the
current repository state and can be regenerated by auditing the source tree.

> **Binary naming note**: The canonical entrypoint shipped by this workspace is
> `oc-rsync` (client plus `--daemon`) as defined in
> `[workspace.metadata.oc_rsync]`. The `oc-rsyncd` shell wrapper and the legacy
> compatibility wrappers (`rsync`, `rsyncd`) remain available and share the same
> execution paths so existing tooling can opt into alternate naming explicitly.

## Implemented
- **Protocol negotiation primitives** (`crates/protocol`): legacy ASCII detection, binary vs.
  legacy prologue sniffing, envelope encoding/decoding, multiplex helpers, and protocol
  selection APIs (`select_highest_mutual`, `ProtocolVersion` constants) are implemented with
  exhaustive unit and property tests.
- **Legacy daemon parsing**: helpers for `@RSYNCD:` banners, error/warning lines, and
  authentication prompts mirror upstream structures and are exported for higher layers.
- **Legacy greeting metadata**: structured parsers expose advertised protocol numbers,
  subprotocol values, and digest lists so higher layers can reproduce upstream
  negotiation decisions without re-parsing raw strings.
- **Transport negotiation sniffing** (`crates/transport`): stream wrappers preserve the
  bytes consumed while determining the negotiation style, expose `Read`/`BufRead`
  views, and provide helpers to parse legacy daemon greetings, control messages,
  errors, and warnings so higher layers can replay the buffered prefix exactly as
  upstream rsync does.
- **Session handshake orchestration** (`crates/transport`): the `session`
  facade unifies binary and legacy handshakes, exposes cap/downgrade
  information, and rehydrates sniffers so higher layers can resume negotiation
  without replaying the underlying transport. The module also surfaces parts-based
  conversions that mirror upstream helpers for continuing with raw transports.
- **Compatibility flag codec** (`crates/protocol`): `CompatibilityFlags` models the
  post-negotiation bitfield while the shared varint helpers encode/decode the
  byte representation used by upstream `write_varint()`/`read_varint()`.
- **Legacy daemon handshake orchestration** (`crates/transport`):
  `daemon::negotiate_legacy_daemon_session` performs the ASCII daemon handshake,
  clamps the negotiated protocol to the caller-provided cap, emits the client's
  greeting banner, and returns the replaying stream together with the parsed
  greeting metadata.
- **Daemon authentication guards** (`crates/daemon`): modules honour the
  `auth users` and `secrets file` directives, enforcing 0600 permissions on
  the secrets file and responding with `@RSYNCD: AUTHREQD <module>` when
  authentication is required.
- **Binary negotiation orchestration** (`crates/transport`):
  `transport::negotiate_binary_session` drives the remote-shell handshake,
  writes the caller's advertised version, reads the peer's response via the
  replaying stream, validates the supported range, and returns the negotiated
  `ProtocolVersion` alongside the buffered transport wrapper.
- **Rolling and strong checksum primitives** (`crates/checksums`): exposes the `rsum`
  rolling checksum together with streaming MD4/MD5/XXH64/XXH3 digests that match upstream
  algorithms, including error handling for invalid rolling-window usage.
- **Deterministic filesystem walker** (`crates/walk`): `WalkBuilder` constructs depth-first
  traversals that yield lexicographically ordered entries while enforcing root-relative paths
  and preventing symlink cycles when following directory links.
- **Centralised message formatting** (`crates/core`): `Message` and `SourceLocation`
  reproduce upstream `rsync error:`/`rsync warning:` prefixes, append
  `[role=3.4.1-rust]` trailers, and normalise Rust `file!()` paths to
  repo-relative form for diagnostics.
- **Client orchestration and local copy pipeline** (`crates/core::client` and
  `crates/engine`): [`run_client`](../crates/core/src/client/mod.rs) delegates to
  [`LocalCopyPlan`](../crates/engine/src/local_copy.rs) for deterministic local
  filesystem copies covering regular files, directories, and symbolic links,
  preserving permissions and timestamps while the full delta engine is under
  construction.
- **Signature generation** (`crates/engine::signature`):
  [`generate_file_signature`](../crates/engine/src/signature.rs) combines the
  block layouts produced by `delta::calculate_signature_layout` with the
  rolling and strong checksum primitives from `rsync_checksums` to emit
  rsync-compatible signatures. The helper honours truncated strong digests and
  validates trailing bytes to match upstream rsync's behaviour, laying the
  groundwork for the upcoming delta-transfer sender path.
- **Logging sinks for message emission** (`crates/logging`):
  [`MessageSink`](../crates/logging/src/lib.rs) wraps `io::Write`
  implementors, reuses `MessageScratch` buffers, and preserves upstream newline
  semantics through an explicit `LineMode` so higher layers can stream
  diagnostics without reimplementing rendering logic.
- **Bandwidth parsing and pacing** (`crates/bandwidth`):
  [`parse_bandwidth_argument`](../crates/bandwidth/src/lib.rs) matches rsync's
  textual syntax (decimal/binary/IEC units, fractional values, and
  `+1`/`-1` adjustments) while [`BandwidthLimiter`](../crates/bandwidth/src/lib.rs)
  reproduces the token-bucket algorithm used by the client, engine, and daemon,
  including deterministic sleep recording for tests.
- **Feature-gated metadata, compression, and logging integration**: optional
  Cargo features plumb end-to-end through the facade. The workspace enables the
  `acl` and `xattr` feature flags by default so local copies honour
  `--acls`/`--xattrs`, advertise the capabilities via `--version`, and reuse
  `MessageSink` for all diagnostics. These toggles remain configurable so
  downstream consumers that lack `libacl` or extended-attribute support can
  disable them explicitly when building custom targets.
  [`CountingZlibEncoder`](../crates/compress/src/zlib.rs),
  [`CountingLz4Encoder`](../crates/compress/src/lz4.rs), and
  [`CountingZstdEncoder`](../crates/compress/src/zstd.rs) mirror upstream
  compression semantics for bandwidth limiting and statistics while native
  network transports are completed.
- **Version constants and feature detection** (`crates/core::version`): exposes
  the canonical `3.4.1-rust` identifier, helpers that surface compiled optional
  capabilities, and [`version_metadata()`](../crates/core/src/version/mod.rs) for
  rendering the upstream `--version` banner.

## Partial
- **Client transfer orchestration (local filesystem + daemon module listing)**
  - *Impact*: `oc-rsync` supports copying regular files, directory trees,
    symbolic links, FIFOs, device nodes (`--devices`/`--specials`), sparse
    files, and hard links on the local filesystem while honouring
    metadata-preservation flags (`--owner`, `--group`, `--perms`, `--times`,
    omit-dir/link-time variants) and optional POSIX ACL/xattr propagation when
    the default feature set is enabled. Reference-directory support (`--compare-dest`, `--copy-dest`,
    `--link-dest`) reuses the engine's block matching to avoid rewrites, and
    append-only flows (`--append`, `--append-verify`) validate existing
    prefixes before resuming transfers. A `--dry-run` validation mode, the full
    deletion family (`--delete*`, `--delete-excluded`, `--remove-source-files`),
    relative-path handling (`--relative`/`-R`), deterministic progress updates,
    and comprehensive `--stats` output (bytes sent/received, matched bytes,
    compression usage, per-kind tallies, file-list timings) are implemented for
    local copies. The client can list `rsync://` modules via the legacy daemon
    handshake. Remote operands are still executed by spawning the system
    `rsync` binary (via the `OC_RSYNC_FALLBACK` override) so users retain full
    transport support while the native delta engine and protocol integration are
    completed. Advanced filter directives beyond the currently implemented
    actions (`+`/`-`, `show`, `hide`, `protect`, `risk`, perishable (`p`),
    `exclude-if-present=FILE`, `merge`/`dir-merge`/`.`/`:` shorthands) remain
    pending for xattr-focused matching and the remaining modifier set.
  - *Removal plan*: Integrate the upcoming transfer engine, metadata pipeline,
    filter grammar, and compression strategies. Extend the facade to drive
    protocol negotiation, networking transports, and progress reporting before
    validating the behaviour against the parity harness.
- **Daemon orchestration (handshake, module listing, and authentication)**
  - *Impact*: `oc-rsync --daemon` binds a TCP listener, performs the legacy
    `@RSYNCD:` negotiation for sequential connections, emits configured MOTD
    lines, responds to `#list` requests using modules provided via
    `--module` arguments or a subset of `rsyncd.conf` parsed from `--config`,
    enforces `hosts allow`/`hosts deny`, and validates `auth users` credentials
    against the configured secrets file using the upstream challenge/response
    scheme. Authenticated module sessions are delegated to the system `rsync`
    binary by default so clients retain full transfers while the native engine
    is completed. Operators can disable delegation explicitly via
    `OC_RSYNC_DAEMON_FALLBACK=0` (or the shared `OC_RSYNC_FALLBACK` override); when
    disabled or when the helper binary is unavailable the daemon still
    terminates sessions with an explanatory `@ERROR` diagnostic after
    authentication.
  - *Removal plan*: Implement module discovery, authentication, and session
    handling in the `daemon` crate, then integrate the code paths with the
    `core` facade so negotiated sessions progress beyond the fallback helper
    into native transfers.
- **CI packaging and upstream interoperability harness**
  - *Impact*: Release automation builds `.deb`, `.rpm`, and tarball artifacts
    for Linux (x86_64/aarch64), macOS (x86_64/aarch64), and Windows
    (x86_64/aarch64) using the optimised `dist` profile, keeping the Windows
    aarch64 lane present but disabled until Zig stabilises native support.
    Platform workflows install the required cross toolchains
    (`gcc-aarch64-linux-gnu`, Zig, and cargo subcommands) before invoking
    `cargo xtask package`, and the resulting artifacts install
    `oc-rsync` under dedicated paths together with the shell wrapper
    `/usr/sbin/oc-rsyncd` so upstream packages can remain on the system. The
    `tools/ci/run_interop.sh` harness now downloads upstream rsync releases
    3.0.9, 3.1.3, and 3.4.1 and exercises both directions—upstream client ↔
    oc-rsyncd and oc-rsync ↔ upstream daemon—to confirm protocol compatibility
    while delegation remains in place.
  - *Removal plan*: Extend the harness with the exit-code oracle, golden tree
    comparisons, and SSH transport coverage so the production-scope matrix is
    fully automated.

## Missing
- **Transfer engine integration with transports**: the
  [`rsync_engine`](../crates/engine/src/delta/) crate emits rsync-compatible
  signatures and delta token streams (see
  [`DeltaGenerator`](../crates/engine/src/delta/generator.rs)), and local copies
  honour compression toggles for statistics and bandwidth limiting via
  [`CountingZlibEncoder`](../crates/engine/src/local_copy.rs),
  [`CountingLz4Encoder`](../crates/engine/src/local_copy/compressor.rs), and,
  when the `zstd` feature is enabled,
  [`CountingZstdEncoder`](../crates/engine/src/local_copy/compressor.rs).
  The pipeline is
  still local-only: comprehensive filter semantics and network transports must
  be wired up, and the client/daemon binaries continue to rely on the system
  `rsync` for real transfers until protocol and transport integration completes.
- **Parity harness and golden comparisons**: Automated `.deb`/`.rpm`
  production, multi-platform tarballs, and upstream interoperability checks are
  in place, but the exit-code oracle, golden filesystem comparisons, and
  end-to-end SSH transport coverage have not been integrated yet.

## Divergent
- None observed; existing modules target upstream rsync 3.4.1 semantics.
