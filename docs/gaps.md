# Implementation Gaps

This document tracks the parity status of the Rust rsync workspace. Each entry reflects the
current repository state and can be regenerated by auditing the source tree.

## Implemented
- **Protocol negotiation primitives** (`crates/protocol`): legacy ASCII detection, binary vs.
  legacy prologue sniffing, envelope encoding/decoding, multiplex helpers, and protocol
  selection APIs (`select_highest_mutual`, `ProtocolVersion` constants) are implemented with
  exhaustive unit and property tests.
- **Legacy daemon parsing**: helpers for `@RSYNCD:` banners, error/warning lines, and
  authentication prompts mirror upstream structures and are exported for higher layers.
- **Legacy greeting metadata**: structured parsers expose advertised protocol numbers,
  subprotocol values, and digest lists so higher layers can reproduce upstream
  negotiation decisions without re-parsing raw strings.
- **Transport negotiation sniffing** (`crates/transport`): stream wrappers preserve the
  bytes consumed while determining the negotiation style, expose `Read`/`BufRead`
  views, and provide helpers to parse legacy daemon greetings, control messages,
  errors, and warnings so higher layers can replay the buffered prefix exactly as
  upstream rsync does.
- **Session handshake orchestration** (`crates/transport`): the `session`
  facade unifies binary and legacy handshakes, exposes cap/downgrade
  information, and rehydrates sniffers so higher layers can resume negotiation
  without replaying the underlying transport. The module also surfaces parts-based
  conversions that mirror upstream helpers for continuing with raw transports.
- **Compatibility flag codec** (`crates/protocol`): `CompatibilityFlags` models the
  post-negotiation bitfield while the shared varint helpers encode/decode the
  byte representation used by upstream `write_varint()`/`read_varint()`.
- **Legacy daemon handshake orchestration** (`crates/transport`):
  `daemon::negotiate_legacy_daemon_session` performs the ASCII daemon handshake,
  clamps the negotiated protocol to the caller-provided cap, emits the client's
  greeting banner, and returns the replaying stream together with the parsed
  greeting metadata.
- **Binary negotiation orchestration** (`crates/transport`):
  `transport::negotiate_binary_session` drives the remote-shell handshake,
  writes the caller's advertised version, reads the peer's response via the
  replaying stream, validates the supported range, and returns the negotiated
  `ProtocolVersion` alongside the buffered transport wrapper.
- **Rolling and strong checksum primitives** (`crates/checksums`): exposes the `rsum`
  rolling checksum together with streaming MD4/MD5/XXH64/XXH3 digests that match upstream
  algorithms, including error handling for invalid rolling-window usage.
- **Deterministic filesystem walker** (`crates/walk`): `WalkBuilder` constructs depth-first
  traversals that yield lexicographically ordered entries while enforcing root-relative paths
  and preventing symlink cycles when following directory links.
- **Centralised message formatting** (`crates/core`): `Message` and `SourceLocation`
  reproduce upstream `rsync error:`/`rsync warning:` prefixes, append
  `[role=3.4.1-rust]` trailers, and normalise Rust `file!()` paths to
  repo-relative form for diagnostics.
- **Client orchestration and local copy pipeline** (`crates/core::client` and
  `crates/engine`): [`run_client`](../crates/core/src/client.rs) delegates to
  [`LocalCopyPlan`](../crates/engine/src/local_copy.rs) for deterministic local
  filesystem copies covering regular files, directories, and symbolic links,
  preserving permissions and timestamps while the full delta engine is under
  construction.
- **Logging sinks for message emission** (`crates/logging`):
  [`MessageSink`](../crates/logging/src/lib.rs) wraps `io::Write`
  implementors, reuses `MessageScratch` buffers, and preserves upstream newline
  semantics through an explicit `LineMode` so higher layers can stream
  diagnostics without reimplementing rendering logic.
- **Version constants and feature detection** (`crates/core::version`): exposes
  the canonical `3.4.1-rust` identifier, helpers that surface compiled optional
  capabilities, and [`version_metadata()`](../crates/core/src/version.rs) for
  rendering the upstream `--version` banner.

## Partial
- **Client transfer orchestration (local filesystem + daemon module listing)**
  - *Impact*: `oc-rsync` supports copying regular files, directory trees,
    symbolic links, FIFOs, and device nodes on the local filesystem, provides
    a `--dry-run` validation mode, supports `--delete` removal of extraneous
    destination entries, recreates hard-linked files as hard links, and can
    list modules from `rsync://` daemons. Remote transports,
    delta compression, extended metadata preservation, filters, bandwidth
    limits, and progress reporting are not yet implemented.
  - *Removal plan*: Integrate the upcoming transfer engine, metadata pipeline,
    filter grammar, and compression strategies. Extend the facade to drive
    protocol negotiation, networking transports, and progress reporting before
    validating the behaviour against the parity harness.
- **Daemon orchestration (handshake and module listing only)**
  - *Impact*: `oc-rsyncd` binds a TCP listener, performs the legacy
    `@RSYNCD:` negotiation for sequential connections, and responds to `#list`
    requests using modules provided via `--module` arguments or a subset of
    `rsyncd.conf` parsed from `--config`. Real module configuration (beyond the
    supported subset), authentication, and file serving remain unavailable.
  - *Removal plan*: Implement module discovery, authentication, and session
    handling in the `daemon` crate, then integrate the code paths with the
    `core` facade so negotiated sessions progress beyond the initial diagnostic.

## Missing
- **Transfer engine extensions and supporting crates**: the
  [`rsync_engine`](../crates/engine/src/local_copy.rs) crate now provides the
  local copy planner used by `oc-rsync`, but delta transfer, filters,
  compression, and sparse handling remain unimplemented. Metadata features such
  as ownership, xattrs, and ACLs are still pending in [`rsync_meta`](../crates/meta/src/lib.rs).
- **Feature gating and runtime integration**: ACL/xattr, compression, metadata
  handling, and logging facades described in the workspace layout have not been
  implemented.
- **CI packaging and interop harnesses**: no automation exists for upstream comparisons,
  packaging, or coverage enforcement beyond unit tests in the protocol crate.

## Divergent
- None observed; existing modules target upstream rsync 3.4.1 semantics.
