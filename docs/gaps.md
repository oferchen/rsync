# Implementation Gaps

This document tracks the parity status of the Rust rsync workspace. Each entry reflects the
current repository state and can be regenerated by auditing the source tree.

## Implemented
- **Protocol negotiation primitives** (`crates/protocol`): legacy ASCII detection, binary vs.
  legacy prologue sniffing, envelope encoding/decoding, multiplex helpers, and protocol
  selection APIs (`select_highest_mutual`, `ProtocolVersion` constants) are implemented with
  exhaustive unit and property tests.
- **Legacy daemon parsing**: helpers for `@RSYNCD:` banners, error/warning lines, and
  authentication prompts mirror upstream structures and are exported for higher layers.
- **Legacy greeting metadata**: structured parsers expose advertised protocol numbers,
  subprotocol values, and digest lists so higher layers can reproduce upstream
  negotiation decisions without re-parsing raw strings.
- **Transport negotiation sniffing** (`crates/transport`): stream wrappers preserve the
  bytes consumed while determining the negotiation style, expose `Read`/`BufRead`
  views, and provide helpers to parse legacy daemon greetings, control messages,
  errors, and warnings so higher layers can replay the buffered prefix exactly as
  upstream rsync does.
- **Session handshake orchestration** (`crates/transport`): the `session`
  facade unifies binary and legacy handshakes, exposes cap/downgrade
  information, and rehydrates sniffers so higher layers can resume negotiation
  without replaying the underlying transport. The module also surfaces parts-based
  conversions that mirror upstream helpers for continuing with raw transports.
- **Compatibility flag codec** (`crates/protocol`): `CompatibilityFlags` models the
  post-negotiation bitfield while the shared varint helpers encode/decode the
  byte representation used by upstream `write_varint()`/`read_varint()`.
- **Legacy daemon handshake orchestration** (`crates/transport`):
  `daemon::negotiate_legacy_daemon_session` performs the ASCII daemon handshake,
  clamps the negotiated protocol to the caller-provided cap, emits the client's
  greeting banner, and returns the replaying stream together with the parsed
  greeting metadata.
- **Daemon authentication guards** (`crates/daemon`): modules honour the
  `auth users` and `secrets file` directives, enforcing 0600 permissions on
  the secrets file and responding with `@RSYNCD: AUTHREQD <module>` when
  authentication is required.
- **Binary negotiation orchestration** (`crates/transport`):
  `transport::negotiate_binary_session` drives the remote-shell handshake,
  writes the caller's advertised version, reads the peer's response via the
  replaying stream, validates the supported range, and returns the negotiated
  `ProtocolVersion` alongside the buffered transport wrapper.
- **Rolling and strong checksum primitives** (`crates/checksums`): exposes the `rsum`
  rolling checksum together with streaming MD4/MD5/XXH64/XXH3 digests that match upstream
  algorithms, including error handling for invalid rolling-window usage.
- **Deterministic filesystem walker** (`crates/walk`): `WalkBuilder` constructs depth-first
  traversals that yield lexicographically ordered entries while enforcing root-relative paths
  and preventing symlink cycles when following directory links.
- **Centralised message formatting** (`crates/core`): `Message` and `SourceLocation`
  reproduce upstream `rsync error:`/`rsync warning:` prefixes, append
  `[role=3.4.1-rust]` trailers, and normalise Rust `file!()` paths to
  repo-relative form for diagnostics.
- **Client orchestration and local copy pipeline** (`crates/core::client` and
  `crates/engine`): [`run_client`](../crates/core/src/client.rs) delegates to
  [`LocalCopyPlan`](../crates/engine/src/local_copy.rs) for deterministic local
  filesystem copies covering regular files, directories, and symbolic links,
  preserving permissions and timestamps while the full delta engine is under
  construction.
- **Signature generation** (`crates/engine::signature`):
  [`generate_file_signature`](../crates/engine/src/signature.rs) combines the
  block layouts produced by `delta::calculate_signature_layout` with the
  rolling and strong checksum primitives from `rsync_checksums` to emit
  rsync-compatible signatures. The helper honours truncated strong digests and
  validates trailing bytes to match upstream rsync's behaviour, laying the
  groundwork for the upcoming delta-transfer sender path.
- **Logging sinks for message emission** (`crates/logging`):
  [`MessageSink`](../crates/logging/src/lib.rs) wraps `io::Write`
  implementors, reuses `MessageScratch` buffers, and preserves upstream newline
  semantics through an explicit `LineMode` so higher layers can stream
  diagnostics without reimplementing rendering logic.
- **Bandwidth parsing and pacing** (`crates/bandwidth`):
  [`parse_bandwidth_argument`](../crates/bandwidth/src/lib.rs) matches rsync's
  textual syntax (decimal/binary/IEC units, fractional values, and
  `+1`/`-1` adjustments) while [`BandwidthLimiter`](../crates/bandwidth/src/lib.rs)
  reproduces the token-bucket algorithm used by the client, engine, and daemon,
  including deterministic sleep recording for tests.
- **Feature-gated metadata, compression, and logging integration**: optional
  Cargo features plumb end-to-end through the facade. Local copies honour
  `--acls`/`--xattrs` when compiled with the respective features, advertise the
  capabilities via `--version`, and reuse `MessageSink` for all diagnostics.
  [`CountingZlibEncoder`](../crates/compress/src/zlib.rs) mirrors upstream
  compression semantics for bandwidth limiting and statistics while native
  network transports are completed.
- **Version constants and feature detection** (`crates/core::version`): exposes
  the canonical `3.4.1-rust` identifier, helpers that surface compiled optional
  capabilities, and [`version_metadata()`](../crates/core/src/version.rs) for
  rendering the upstream `--version` banner.

## Partial
- **Client transfer orchestration (local filesystem + daemon module listing)**
  - *Impact*: `rsync` supports copying regular files, directory trees,
    symbolic links, FIFOs, and device nodes on the local filesystem (when
    `--specials`/`--devices` are requested), provides
    a `--dry-run` validation mode, supports `--delete`, `--delete-after`, and `--delete-delay` removal of extraneous
    destination entries, recreates hard-linked files as hard links, preserves
    ownership and group metadata when `--owner`/`--group` are passed, preserves
    sparse files when `--sparse` is requested, honours `--relative`/`-R` when
    copying local sources, consults reference directories supplied via
    `--compare-dest`/`--copy-dest`/`--link-dest`, and can list modules from
    `rsync://` daemons. Remote
    operands are executed by spawning the system `rsync` binary (via the
    `OC_RSYNC_FALLBACK` override) so users retain full transport support while
    the native delta engine and protocol integration are completed. POSIX ACLs
    and extended attributes are preserved when the corresponding features are
    compiled and the user requests `--acls`/`--xattrs`. Advanced filter directives beyond
    `--filter` `+`/`-` actions, `show PATTERN`, `hide PATTERN`,
    `protect PATTERN`, `risk PATTERN`, `exclude-if-present=FILE`, and
    `merge`/`dir-merge` directives (including their short `.`/`:` forms)
    remain unimplemented. Progress reporting now streams live, in-place updates
    while the richer delta-transfer metrics remain pending.
  - *Removal plan*: Integrate the upcoming transfer engine, metadata pipeline,
    filter grammar, and compression strategies. Extend the facade to drive
    protocol negotiation, networking transports, and progress reporting before
    validating the behaviour against the parity harness.
- **Daemon orchestration (handshake, module listing, and authentication)**
  - *Impact*: `rsyncd` binds a TCP listener, performs the legacy
    `@RSYNCD:` negotiation for sequential connections, emits configured MOTD
    lines, responds to `#list` requests using modules provided via
    `--module` arguments or a subset of `rsyncd.conf` parsed from `--config`,
    enforces `hosts allow`/`hosts deny`, and validates `auth users` credentials
    against the configured secrets file using the upstream challenge/response
    scheme. Authenticated module sessions are delegated to the system `rsync`
    binary by default so clients retain full transfers while the native engine
    is completed. Operators can disable delegation explicitly via
    `OC_RSYNC_DAEMON_FALLBACK=0` (or the shared `OC_RSYNC_FALLBACK` override); when
    disabled or when the helper binary is unavailable the daemon still
    terminates sessions with an explanatory `@ERROR` diagnostic after
    authentication.
  - *Removal plan*: Implement module discovery, authentication, and session
    handling in the `daemon` crate, then integrate the code paths with the
    `core` facade so negotiated sessions progress beyond the fallback helper
    into native transfers.

## Missing
- **Transfer engine integration with transports**: the
  [`rsync_engine`](../crates/engine/src/delta/) crate emits rsync-compatible
  signatures and delta token streams (see
  [`DeltaGenerator`](../crates/engine/src/delta/generator.rs)), and local copies
  honour compression toggles for statistics and bandwidth limiting via
  [`CountingZlibEncoder`](../crates/engine/src/local_copy.rs). The pipeline is
  still local-only: comprehensive filter semantics and network transports must
  be wired up, and the client/daemon binaries continue to rely on the system
  `rsync` for real transfers until protocol and transport integration completes.
- **CI packaging and interop harnesses**: no automation exists for upstream comparisons
  or coverage enforcement beyond unit tests in the protocol crate. SBOM generation is
  now covered by `cargo xtask sbom`, but the remaining packaging checks and interop
  matrix still need to be wired into CI.

## Divergent
- None observed; existing modules target upstream rsync 3.4.1 semantics.
