#!/bin/sh
set -e

ALT_NAME="rsync"
ALT_MASTER="/usr/bin/rsync"
ALT_IMPL="/usr/libexec/oc-rsync/rsync"
ALT_SLAVE_NAME="rsyncd"
ALT_SLAVE_LINK="/usr/bin/rsyncd"
ALT_SLAVE_IMPL="/usr/libexec/oc-rsync/rsyncd"
ALT_PRIORITY=30
DEFAULTS_FILE="/etc/default/oc-rsyncd"

is_truthy() {
    case "$1" in
        [Yy][Ee][Ss]|[Tt][Rr][Uu][Ee]|1)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

have_update_alternatives() {
    command -v update-alternatives >/dev/null 2>&1
}

should_register_alternatives() {
    if [ -n "${OC_RSYNC_PACKAGE_REGISTER_ALTERNATIVES:-}" ]; then
        if is_truthy "${OC_RSYNC_PACKAGE_REGISTER_ALTERNATIVES}"; then
            return 0
        fi
        return 1
    fi

    if [ -r "${DEFAULTS_FILE}" ]; then
        # shellcheck source=/etc/default/oc-rsyncd
        . "${DEFAULTS_FILE}"
    fi

    if is_truthy "${OC_RSYNC_REGISTER_ALTERNATIVES:-}"; then
        return 0
    fi

    return 1
}

upstream_rsync_installed() {
    if command -v dpkg-query >/dev/null 2>&1; then
        if dpkg-query -W -f='${Status}' rsync 2>/dev/null | grep -q 'install ok installed'; then
            return 0
        fi
    fi

    return 1
}

register_alternatives() {
    if ! have_update_alternatives; then
        return 0
    fi

    if ! should_register_alternatives; then
        printf '%s\n' "Skipping update-alternatives registration for oc-rsync; set OC_RSYNC_PACKAGE_REGISTER_ALTERNATIVES=1 or enable OC_RSYNC_REGISTER_ALTERNATIVES in /etc/default/oc-rsyncd to opt in." >&2
        return 0
    fi

    if upstream_rsync_installed; then
        # Preserve the upstream package's rsync binary. Administrators can
        # opt-in to update-alternatives manually if they prefer the Rust
        # implementation as the system default.
        return 0
    fi

    if [ -e "${ALT_MASTER}" ] && [ ! -L "${ALT_MASTER}" ]; then
        if ! update-alternatives --display "${ALT_NAME}" >/dev/null 2>&1; then
            return 0
        fi
    fi

    update-alternatives \
        --install "${ALT_MASTER}" "${ALT_NAME}" "${ALT_IMPL}" "${ALT_PRIORITY}" \
        --slave "${ALT_SLAVE_LINK}" "${ALT_SLAVE_NAME}" "${ALT_SLAVE_IMPL}" \
        >/dev/null
}

case "$1" in
    configure)
        register_alternatives
        ;;
    abort-upgrade|abort-remove|abort-deconfigure)
        :
        ;;
    *)
        :
        ;;
esac

exit 0
