name: Build-cross

# =============================================================================
# Release Workflow
# =============================================================================
# This workflow handles the complete release process:
#   1. Validates tag matches Cargo.toml version (fail-fast)
#   2. Builds release artifacts for all platforms
#   3. Uploads artifacts to GitHub Release
#   4. Updates Homebrew formula and creates PR
#
# Trigger: Push a tag matching vX.Y.Z (e.g., v0.5.1)
# Prerequisites: Cargo.toml version MUST match the tag (without 'v' prefix)
# =============================================================================

on:
  push:
    tags:
      # Semantic versioning: v0.5.0, v1.0.0, v1.2.3
      - "v[0-9]*.[0-9]*.[0-9]*"
      # Legacy branded: v3.4.1-rust, v3.4.1a-rust
      - "v[0-9]*.[0-9]*.[0-9]*-rust"
      - "v[0-9]*.[0-9]*.[0-9]*[a-z]-rust"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUST_BACKTRACE: "full"
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  # ===========================================================================
  # Version Validation (fail-fast gate)
  # ===========================================================================
  validate-version:
    name: validate tag matches Cargo.toml
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.extract.outputs.version }}
      tag: ${{ steps.extract.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract and validate version
        id: extract
        shell: bash
        run: |
          set -euo pipefail

          # Extract tag from ref (refs/tags/v0.5.1 -> v0.5.1)
          TAG="${GITHUB_REF##*/}"
          VERSION="${TAG#v}"  # Strip leading 'v'

          # Extract version from Cargo.toml
          CARGO_VERSION="$(grep -E '^version\s*=' Cargo.toml | head -1 | sed 's/.*"\([^"]*\)".*/\1/')"

          printf 'Tag: %s\n' "${TAG}"
          printf 'Tag version: %s\n' "${VERSION}"
          printf 'Cargo.toml version: %s\n' "${CARGO_VERSION}"

          # Validate versions match
          if [ "${VERSION}" != "${CARGO_VERSION}" ]; then
            printf '::error::Version mismatch! Tag %s does not match Cargo.toml version %s\n' "${TAG}" "${CARGO_VERSION}"
            printf '\nTo fix this:\n'
            printf '  1. Update Cargo.toml: version = "%s"\n' "${VERSION}"
            printf '  2. Commit and push\n'
            printf '  3. Delete and recreate tag: git tag -d %s && git tag %s && git push origin %s --force\n' "${TAG}" "${TAG}" "${TAG}"
            exit 1
          fi

          printf '::notice::Version validated: %s\n' "${VERSION}"
          printf 'version=%s\n' "${VERSION}" >> "${GITHUB_OUTPUT}"
          printf 'tag=%s\n' "${TAG}" >> "${GITHUB_OUTPUT}"

  # ===========================================================================
  # Build Jobs (all depend on version validation)
  # ===========================================================================
  linux:
    name: linux release artifacts
    runs-on: ubuntu-latest
    needs: validate-version
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-linux

      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail

          # Enable arm64 multiarch
          sudo dpkg --add-architecture arm64

          # Discover codename (e.g. noble)
          . /etc/os-release
          codename="${UBUNTU_CODENAME:-${VERSION_CODENAME}}"
          printf 'Ubuntu codename: %s\n' "${codename}"

          # If deb822 ubuntu.sources exists (24.04+), make it amd64-only
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sudo awk '
              BEGIN { in_stanza = 0; had_arch = 0 }
              /^Types:/ { in_stanza = 1; had_arch = 0 }
              /^$/     { in_stanza = 0; had_arch = 0 }
              /^Architectures:/ { had_arch = 1 }
              {
                print
                if (in_stanza && /^Components:/ && !had_arch) {
                  print "Architectures: amd64"
                  had_arch = 1
                }
              }
            ' /etc/apt/sources.list.d/ubuntu.sources \
              | sudo tee /etc/apt/sources.list.d/ubuntu.sources.new >/dev/null
            sudo mv /etc/apt/sources.list.d/ubuntu.sources.new /etc/apt/sources.list.d/ubuntu.sources
          fi

          # Add ports.ubuntu.com for arm64
          sudo sh -c '
            codename="$1"
            {
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s %s-updates %s-backports\n" "$codename" "$codename" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
              printf "\n"
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s-security\n" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
            } > /etc/apt/sources.list.d/ubuntu-ports-arm64.sources
          ' sh "$codename"

          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get -y install \
            pkg-config \
            libssl-dev \
            libacl1-dev \
            libattr1-dev \
            libzstd-dev \
            zlib1g-dev \
            libxxhash-dev \
            gcc-aarch64-linux-gnu \
            libssl-dev:arm64 \
            libacl1-dev:arm64 \
            libattr1-dev:arm64 \
            libzstd-dev:arm64 \
            zlib1g-dev:arm64 \
            libxxhash-dev:arm64

      - name: Install cargo-deb and cargo-rpm
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v cargo-deb >/dev/null 2>&1; then
            cargo install --locked cargo-deb
          fi

          if ! command -v cargo-rpm >/dev/null 2>&1; then
            cargo install --locked cargo-rpm
          fi

      - name: Build Linux packages (deb + tarball, try RPM)
        shell: bash
        run: |
          set -euo pipefail

          printf 'Running cargo xtask package with RPM...\n'
          if cargo xtask package \
              --deb \
              --rpm \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --profile dist
          then
            printf 'cargo xtask package (with RPM) completed successfully.\n'
          else
            printf 'cargo xtask package failed (likely during RPM build).\n'
            printf 'Falling back to packaging without RPM...\n'
            cargo xtask package \
              --deb \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --profile dist
          fi

      - name: Build Linux aarch64 artifacts (tarball + deb + rpm)
        shell: bash
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
        run: |
          set -euo pipefail
          printf 'Running cargo xtask package for aarch64 (tarball)...\n'
          cargo xtask package \
            --tarball \
            --tarball-target aarch64-unknown-linux-gnu \
            --profile dist

          printf 'Building aarch64 .deb (reusing dist binaries)...\n'
          cargo deb \
            --target aarch64-unknown-linux-gnu \
            --no-build \
            --profile dist

          printf 'Building aarch64 .rpm (reusing dist binaries)...\n'
          if cargo rpm build \
              --target aarch64-unknown-linux-gnu \
              --output target/dist/
          then
            printf 'cargo rpm build (aarch64) completed successfully.\n'
          else
            printf 'cargo rpm build (aarch64) failed; skipping aarch64 RPM.\n'
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          retention-days: 7
          path: |
            target/dist/oc-rsync-*-linux-*.tar.gz
            target/debian/oc-rsync_*_amd64.deb
            target/aarch64-unknown-linux-gnu/debian/oc-rsync_*_arm64.deb
            target/dist/oc-rsync-*.rpm


  linux-focal:
    name: linux focal release artifacts (Ubuntu 20.04)
    runs-on: ubuntu-20.04
    needs: validate-version
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-linux-focal

      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get -y install \
            pkg-config \
            libssl-dev \
            libacl1-dev \
            libattr1-dev \
            libzstd-dev \
            zlib1g-dev \
            libxxhash-dev \
            gcc-aarch64-linux-gnu

      - name: Install cargo-deb
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v cargo-deb >/dev/null 2>&1; then
            cargo install --locked cargo-deb
          fi

      - name: Build Linux focal x86_64 deb
        shell: bash
        run: |
          set -euo pipefail
          printf 'Building focal variant deb for x86_64...\n'
          cargo xtask package \
            --deb \
            --deb-variant focal \
            --profile dist

      - name: Build Linux focal aarch64 deb
        shell: bash
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
        run: |
          set -euo pipefail
          printf 'Building focal variant deb for aarch64...\n'
          cargo build \
            --release \
            --target aarch64-unknown-linux-gnu \
            --profile dist
          cargo deb \
            --target aarch64-unknown-linux-gnu \
            --no-build \
            --variant focal \
            --profile dist
          # Rename to include focal suffix
          DEBFILE=$(ls target/aarch64-unknown-linux-gnu/debian/oc-rsync_*_arm64.deb 2>/dev/null | head -1)
          if [ -n "$DEBFILE" ] && [ -f "$DEBFILE" ]; then
            NEWNAME="${DEBFILE%.deb}_focal.deb"
            mv "$DEBFILE" "$NEWNAME"
            printf 'Renamed %s -> %s\n' "$(basename "$DEBFILE")" "$(basename "$NEWNAME")"
          fi

      - name: Upload Linux focal artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-focal
          retention-days: 7
          path: |
            target/dist/oc-rsync_*_amd64_focal.deb
            target/aarch64-unknown-linux-gnu/debian/oc-rsync_*_arm64_focal.deb

  macos:
    name: macOS release artifacts
    runs-on: macos-latest
    needs: validate-version
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-macos

      - name: Install OpenSSL
        run: |
          brew update
          brew install openssl@3 || true
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Build macOS aarch64 tarball
        run: cargo xtask package --tarball --tarball-target aarch64-apple-darwin --profile dist

      - name: Build macOS x86_64 tarball
        run: cargo xtask package --tarball --tarball-target x86_64-apple-darwin --profile dist

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          retention-days: 7
          path: target/dist/oc-rsync-*-darwin-*.tar.gz

  windows:
    name: windows release artifacts
    runs-on: windows-latest
    needs: validate-version
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-windows

      - name: Disable rustc wrapper if configured
        shell: pwsh
        run: |
          $configPath = ".cargo/config.toml"
          if (Test-Path $configPath) {
            $content = Get-Content -Path $configPath -Encoding UTF8
            $filtered = $content | Where-Object { $_ -notmatch '^\s*rustc-wrapper\s*=' }
            $filtered | Set-Content -Path $configPath -Encoding UTF8
          }
          "RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_BUILD_RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Windows tarball
        shell: pwsh
        run: |
          $env:OC_RSYNC_PACKAGE_DEFAULT_FEATURES = "0"
          $env:OC_RSYNC_PACKAGE_FEATURES = "zstd lz4 iconv"
          cargo xtask package --tarball --tarball-target x86_64-pc-windows-msvc --profile dist

      - name: Create Windows zip archive
        shell: pwsh
        run: |
          $distDir = Join-Path (Get-Location) "dist"
          if (-not (Test-Path $distDir)) {
            New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          }
          $tarball = Get-ChildItem -Path (Join-Path (Get-Location) "target\dist") -Filter "oc-rsync-*-windows-*.tar.gz" | Select-Object -First 1
          if ($null -eq $tarball) {
            throw "expected windows tarball to exist"
          }
          $profileDir = Join-Path (Get-Location) "target\x86_64-pc-windows-msvc\dist"
          $binaries = Get-ChildItem -Path $profileDir -Filter "*.exe" | Where-Object { $_.Name -match '^(oc-rsync|rsync)' }
          if ($binaries.Count -eq 0) {
            throw "no Windows binaries found for zip packaging"
          }
          $zipPath = Join-Path $distDir ($tarball.BaseName + ".zip")
          Compress-Archive -Path $binaries.FullName -DestinationPath $zipPath -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          retention-days: 7
          path: |
            target/dist/oc-rsync-*-windows-*.tar.gz
            dist/*.zip

  release-artifacts:
    name: create GitHub Release and upload assets
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - validate-version
      - linux
      - linux-focal
      - macos
      - windows

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Verify artifacts
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Verifying all expected artifacts are present ==="

          # Define expected artifact patterns
          declare -a REQUIRED_PATTERNS=(
            "dist/**/oc-rsync-*-linux-x86_64.tar.gz"
            "dist/**/oc-rsync-*-linux-aarch64.tar.gz"
            "dist/**/oc-rsync-*-darwin-x86_64.tar.gz"
            "dist/**/oc-rsync-*-darwin-aarch64.tar.gz"
            "dist/**/oc-rsync-*-windows-x86_64.tar.gz"
            "dist/**/oc-rsync_*_amd64.deb"
            "dist/**/oc-rsync_*_arm64.deb"
          )

          MISSING=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! ls $pattern 1>/dev/null 2>&1; then
              echo "::error::Missing required artifact: $pattern"
              MISSING=$((MISSING + 1))
            else
              echo "âœ“ Found: $pattern"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "::error::$MISSING required artifacts are missing!"
            exit 1
          fi

          echo "=== All required artifacts verified ==="

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/**/oc-rsync-*-windows-*.tar.gz
            dist/**/oc-rsync-*-darwin-*.tar.gz
            dist/**/oc-rsync-*-linux-*.tar.gz
            dist/**/oc-rsync_*_amd64.deb
            dist/**/oc-rsync_*_arm64.deb
            dist/**/oc-rsync_*_amd64_focal.deb
            dist/**/oc-rsync_*_arm64_focal.deb
            dist/**/oc-rsync-*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  brew-formula:
    name: update Homebrew formula
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - validate-version
      - linux
      - macos
      - windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-macos
          path: dist-macos

      - name: Extract branding metadata
        id: branding
        shell: bash
        run: |
          set -euo pipefail
          # Extract upstream_version from workspace metadata for formula description
          UPSTREAM_VERSION="$(grep -E '^\s*upstream_version\s*=' Cargo.toml | head -1 | sed 's/.*=\s*"\([^"]*\)".*/\1/')"
          printf 'upstream_version=%s\n' "${UPSTREAM_VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Generate Homebrew formula
        shell: bash
        env:
          FORMULA_PATH: Formula/oc-rsync.rb
          UPSTREAM_VERSION: ${{ steps.branding.outputs.upstream_version }}
        run: |
          set -euo pipefail

          TAG="${{ needs.validate-version.outputs.tag }}"
          VERSION="${{ needs.validate-version.outputs.version }}"
          REPO="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"

          mkdir -p Formula

          # Find actual macOS tarballs from artifacts (accepts both x86_64/amd64 and aarch64/arm64)
          AMD64_PATH="$(find dist-macos -maxdepth 1 -type f \( -name 'oc-rsync-*darwin*x86_64*.tar.gz' -o -name 'oc-rsync-*darwin*amd64*.tar.gz' \) | sort | head -n1 || true)"
          ARM64_PATH="$(find dist-macos -maxdepth 1 -type f \( -name 'oc-rsync-*darwin*aarch64*.tar.gz' -o -name 'oc-rsync-*darwin*arm64*.tar.gz' \) | sort | head -n1 || true)"

          if [ -z "${AMD64_PATH}" ] || [ -z "${ARM64_PATH}" ]; then
            printf 'Could not locate both macOS amd64 and arm64 tarballs in dist-macos\n' >&2
            ls -R dist-macos || true
            exit 1
          fi

          AMD64_TARBALL="$(basename "${AMD64_PATH}")"
          ARM64_TARBALL="$(basename "${ARM64_PATH}")"

          AMD64_SHA256="$(shasum -a 256 "${AMD64_PATH}" | awk '{print $1}')"
          ARM64_SHA256="$(shasum -a 256 "${ARM64_PATH}" | awk '{print $1}')"

          {
            echo "class OcRsync < Formula"
            echo "  desc \"Pure-Rust rsync ${UPSTREAM_VERSION}-compatible implementation\""
            echo '  homepage "https://github.com/oferchen/rsync"'
            echo '  license "GPL-3.0-or-later"'
            echo "  version \"${VERSION}\""
            echo
            echo "  on_macos do"
            echo "    on_intel do"
            echo "      url \"${REPO}/${AMD64_TARBALL}\""
            echo "      sha256 \"${AMD64_SHA256}\""
            echo "    end"
            echo
            echo "    on_arm do"
            echo "      url \"${REPO}/${ARM64_TARBALL}\""
            echo "      sha256 \"${ARM64_SHA256}\""
            echo "    end"
            echo "  end"
            echo
            echo "  def install"
            echo "    bin.install \"bin/oc-rsync\""
            echo "  end"
            echo
            echo "  test do"
            echo "    system \"#{bin}/oc-rsync\", \"--version\""
            echo "  end"
            echo "end"
          } > "${FORMULA_PATH}"

          printf 'Formula generated at %s\n' "${FORMULA_PATH}"

      - name: Commit and push formula branch
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ needs.validate-version.outputs.tag }}"
          BRANCH="ci/brew-formula-${TAG}"

          # Save the generated formula before any git operations
          cp "${FORMULA_PATH}" /tmp/oc-rsync.rb

          git config user.name "oc-rsync-bot"
          git config user.email "actions@github.com"

          # Configure git to use the PAT for push operations
          git remote set-url origin "https://x-access-token:${BREW_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Fetch master branch explicitly (refs/heads/master) to avoid ambiguity in shallow tag checkouts
          git fetch origin refs/heads/master --depth=1

          # Force checkout to discard local changes from formula generation step
          git checkout --force -B "${BRANCH}" FETCH_HEAD

          # Restore the generated formula file
          mkdir -p "$(dirname "${FORMULA_PATH}")"
          cp /tmp/oc-rsync.rb "${FORMULA_PATH}"

          git add "${FORMULA_PATH}"

          if git diff --cached --quiet; then
            printf 'No changes to commit; skipping push.\n'
            exit 0
          fi

          git commit -m "chore: update Homebrew formula for ${TAG}"
          git push --force origin "${BRANCH}"

          printf 'Pushed branch %s\n' "${BRANCH}"
        env:
          BREW_TOKEN: ${{ secrets.OC_RSYNC_BREW_TOKEN }}

      - name: Create pull request
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ needs.validate-version.outputs.tag }}"
          BRANCH="ci/brew-formula-${TAG}"

          # Check if PR already exists
          PR_URL=$(gh pr list --head "${BRANCH}" --json url --jq '.[0].url' 2>/dev/null || true)
          if [ -n "${PR_URL}" ]; then
            printf 'PR already exists: %s\n' "${PR_URL}"
            exit 0
          fi

          # Create the pull request
          BODY=$(cat <<'PREOF'
          This PR updates the Homebrew formula.

          ## Changes
          - Updates formula with new version and SHA256 checksums
          - Auto-generated by CI on tag push

          ## Testing
          ```bash
          brew install --build-from-source ./Formula/oc-rsync.rb
          ```
          PREOF
          )

          gh pr create \
            --title "chore: update Homebrew formula for ${TAG}" \
            --body "${BODY}" \
            --base master \
            --head "${BRANCH}"
        env:
          GH_TOKEN: ${{ secrets.OC_RSYNC_BREW_TOKEN }}
