name: Interop Validation

on:
  push:
    branches: [ master, main ]
    paths:
      - 'crates/**'
      - 'src/**'
      - 'tests/**'
      - 'tools/ci/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/interop-validation.yml'
  pull_request:
    paths:
      - 'crates/**'
      - 'src/**'
      - 'tests/**'
      - 'tools/ci/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/interop-validation.yml'
  workflow_dispatch:
  schedule:
    # Run nightly to catch drift in upstream versions
    - cron: '0 2 * * *'

concurrency:
  group: interop-validation-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CACHE_VERSION: ${{ vars.CACHE_VERSION || 'v1' }}
  UPSTREAM_RSYNC_VERSION: ${{ vars.UPSTREAM_RSYNC_VERSION || '3.4.1' }}

jobs:
  validate-exit-codes:
    name: Exit Code Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: interop-${{ env.CACHE_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          key: exit-codes

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@2c09a5e66da6c8016428a2172bd76e5e4f14bb17 # v1
        with:
          packages: build-essential pkg-config zlib1g-dev curl autoconf automake libtool libacl1-dev libattr1-dev
          version: ${{ env.CACHE_VERSION }}

      - name: Cache upstream rsync
        id: cache-rsync
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            target/interop/upstream-src
            target/interop/upstream-install
          key: upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-${{ hashFiles('tools/ci/run_interop.sh') }}
          restore-keys: |
            upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-

      - name: Build upstream rsync binaries
        if: steps.cache-rsync.outputs.cache-hit != 'true'
        run: bash tools/ci/run_interop.sh build-only

      - name: Build oc-rsync
        run: cargo build --release

      - name: Validate exit codes
        id: validate-exit-codes
        run: |
          cargo xtask interop exit-codes --verbose
        continue-on-error: true

      - name: Upload validation report
        if: failure() && steps.validate-exit-codes.outcome == 'failure'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: exit-code-validation-report
          path: |
            tests/interop/exit_codes/golden-*.toml
          retention-days: 7

      - name: Fail if validation failed
        if: steps.validate-exit-codes.outcome == 'failure'
        run: exit 1

  validate-messages:
    name: Message Format Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: interop-${{ env.CACHE_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          key: messages

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@2c09a5e66da6c8016428a2172bd76e5e4f14bb17 # v1
        with:
          packages: build-essential pkg-config zlib1g-dev curl autoconf automake libtool libacl1-dev libattr1-dev
          version: ${{ env.CACHE_VERSION }}

      - name: Cache upstream rsync
        id: cache-rsync
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            target/interop/upstream-src
            target/interop/upstream-install
          key: upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-${{ hashFiles('tools/ci/run_interop.sh') }}
          restore-keys: |
            upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-

      - name: Build upstream rsync binaries
        if: steps.cache-rsync.outputs.cache-hit != 'true'
        run: bash tools/ci/run_interop.sh build-only

      - name: Build oc-rsync
        run: cargo build --release

      - name: Validate messages
        id: validate-messages
        run: |
          cargo xtask interop messages --verbose
        continue-on-error: true

      - name: Upload validation report
        if: failure() && steps.validate-messages.outcome == 'failure'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: message-validation-report
          path: |
            tests/interop/messages/golden-*.toml
          retention-days: 7

      - name: Fail if validation failed
        if: steps.validate-messages.outcome == 'failure'
        run: exit 1

  regenerate-goldens:
    name: Regenerate Golden Files (Manual)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Only run on workflow_dispatch
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: interop-${{ env.CACHE_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          key: regenerate

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@2c09a5e66da6c8016428a2172bd76e5e4f14bb17 # v1
        with:
          packages: build-essential pkg-config zlib1g-dev curl autoconf automake libtool libacl1-dev libattr1-dev
          version: ${{ env.CACHE_VERSION }}

      - name: Cache upstream rsync
        id: cache-rsync
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            target/interop/upstream-src
            target/interop/upstream-install
          key: upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-${{ hashFiles('tools/ci/run_interop.sh') }}
          restore-keys: |
            upstream-rsync-${{ env.UPSTREAM_RSYNC_VERSION }}-${{ runner.os }}-

      - name: Build upstream rsync binaries
        if: steps.cache-rsync.outputs.cache-hit != 'true'
        run: bash tools/ci/run_interop.sh build-only

      - name: Regenerate exit code goldens
        run: cargo xtask interop exit-codes --regenerate --verbose

      - name: Regenerate message goldens
        run: cargo xtask interop messages --regenerate --verbose

      - name: Upload regenerated goldens
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: regenerated-golden-files
          path: |
            tests/interop/exit_codes/golden-*.toml
            tests/interop/messages/golden-*.toml
          retention-days: 30

      - name: Create summary
        run: |
          echo "## Regenerated Golden Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Exit code goldens:" >> $GITHUB_STEP_SUMMARY
          ls -1 tests/interop/exit_codes/golden-*.toml | while read f; do
            echo "- $f" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Message goldens:" >> $GITHUB_STEP_SUMMARY
          ls -1 tests/interop/messages/golden-*.toml 2>/dev/null | while read f; do
            echo "- $f" >> $GITHUB_STEP_SUMMARY
          done || echo "- (none found)" >> $GITHUB_STEP_SUMMARY
