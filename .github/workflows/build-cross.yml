name: Build-cross

on:
  push:
    tags:
      - "v*.*.*-rust"
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUST_BACKTRACE: "full"
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  linux:
    name: linux release artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-linux

      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail

          # Enable arm64 multiarch
          sudo dpkg --add-architecture arm64

          # Discover codename (e.g. noble)
          . /etc/os-release
          codename="${UBUNTU_CODENAME:-${VERSION_CODENAME}}"
          printf 'Ubuntu codename: %s\n' "${codename}"

          # If deb822 ubuntu.sources exists (24.04+), make it amd64-only
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sudo awk '
              BEGIN { in_stanza = 0; had_arch = 0 }
              /^Types:/ { in_stanza = 1; had_arch = 0 }
              /^$/     { in_stanza = 0; had_arch = 0 }
              /^Architectures:/ { had_arch = 1 }
              {
                print
                if (in_stanza && /^Components:/ && !had_arch) {
                  print "Architectures: amd64"
                  had_arch = 1
                }
              }
            ' /etc/apt/sources.list.d/ubuntu.sources \
              | sudo tee /etc/apt/sources.list.d/ubuntu.sources.new >/dev/null
            sudo mv /etc/apt/sources.list.d/ubuntu.sources.new /etc/apt/sources.list.d/ubuntu.sources
          fi

          # Add ports.ubuntu.com for arm64
          sudo sh -c '
            codename="$1"
            {
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s %s-updates %s-backports\n" "$codename" "$codename" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
              printf "\n"
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s-security\n" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
            } > /etc/apt/sources.list.d/ubuntu-ports-arm64.sources
          ' sh "$codename"

          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get -y install \
            pkg-config \
            libssl-dev \
            libacl1-dev \
            libattr1-dev \
            libzstd-dev \
            zlib1g-dev \
            libxxhash-dev \
            gcc-aarch64-linux-gnu \
            libssl-dev:arm64 \
            libacl1-dev:arm64 \
            libattr1-dev:arm64 \
            libzstd-dev:arm64 \
            zlib1g-dev:arm64 \
            libxxhash-dev:arm64

      - name: Install cargo-deb and cargo-rpm
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v cargo-deb >/dev/null 2>&1; then
            cargo install --locked cargo-deb
          fi

          if ! command -v cargo-rpm >/dev/null 2>&1; then
            cargo install --locked cargo-rpm
          fi

      - name: Build Linux packages (deb + tarball, try RPM)
        shell: bash
        run: |
          set -euo pipefail

          printf 'Running cargo xtask package with RPM...\n'
          if cargo xtask package \
              --deb \
              --rpm \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --profile dist
          then
            printf 'cargo xtask package (with RPM) completed successfully.\n'
          else
            printf 'cargo xtask package failed (likely during RPM build).\n'
            printf 'Falling back to packaging without RPM...\n'
            cargo xtask package \
              --deb \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --profile dist
          fi

      - name: Build Linux aarch64 artifacts (tarball + deb + rpm)
        shell: bash
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
        run: |
          set -euo pipefail
          printf 'Running cargo xtask package for aarch64 (tarball)...\n'
          cargo xtask package \
            --tarball \
            --tarball-target aarch64-unknown-linux-gnu \
            --profile dist

          printf 'Building aarch64 .deb (reusing dist binaries)...\n'
          cargo deb \
            --target aarch64-unknown-linux-gnu \
            --no-build \
            --profile dist

          printf 'Building aarch64 .rpm (reusing dist binaries)...\n'
          if cargo rpm build \
              --target aarch64-unknown-linux-gnu \
              --output target/dist/
          then
            printf 'cargo rpm build (aarch64) completed successfully.\n'
          else
            printf 'cargo rpm build (aarch64) failed; skipping aarch64 RPM.\n'
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            target/dist/oc-rsync-*-linux-*.tar.gz
            target/debian/oc-rsync_*_amd64.deb
            target/aarch64-unknown-linux-gnu/debian/oc-rsync_*_arm64.deb
            target/dist/oc-rsync-*.rpm


  macos:
    name: macOS release artifacts
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-macos

      - name: Install OpenSSL
        run: |
          brew update
          brew install openssl@3 || true
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Build macOS aarch64 tarball
        run: cargo xtask package --tarball --tarball-target aarch64-apple-darwin --profile dist

      - name: Build macOS x86_64 tarball
        run: cargo xtask package --tarball --tarball-target x86_64-apple-darwin --profile dist

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: target/dist/oc-rsync-*-darwin-*.tar.gz

  windows:
    name: windows release artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-windows

      - name: Disable rustc wrapper if configured
        shell: pwsh
        run: |
          $configPath = ".cargo/config.toml"
          if (Test-Path $configPath) {
            $content = Get-Content -Path $configPath -Encoding UTF8
            $filtered = $content | Where-Object { $_ -notmatch '^\s*rustc-wrapper\s*=' }
            $filtered | Set-Content -Path $configPath -Encoding UTF8
          }
          "RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_BUILD_RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Windows tarball
        shell: pwsh
        run: |
          $env:OC_RSYNC_PACKAGE_DEFAULT_FEATURES = "0"
          $env:OC_RSYNC_PACKAGE_FEATURES = "zstd lz4 iconv"
          cargo xtask package --tarball --tarball-target x86_64-pc-windows-msvc --profile dist

      - name: Create Windows zip archive
        shell: pwsh
        run: |
          $distDir = Join-Path (Get-Location) "dist"
          if (-not (Test-Path $distDir)) {
            New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          }
          $tarball = Get-ChildItem -Path (Join-Path (Get-Location) "target\dist") -Filter "oc-rsync-*-windows-*.tar.gz" | Select-Object -First 1
          if ($null -eq $tarball) {
            throw "expected windows tarball to exist"
          }
          $profileDir = Join-Path (Get-Location) "target\x86_64-pc-windows-msvc\dist"
          $binaries = Get-ChildItem -Path $profileDir -Filter "*.exe" | Where-Object { $_.Name -match '^(oc-rsync|rsync)' }
          if ($binaries.Count -eq 0) {
            throw "no Windows binaries found for zip packaging"
          }
          $zipPath = Join-Path $distDir ($tarball.BaseName + ".zip")
          Compress-Archive -Path $binaries.FullName -DestinationPath $zipPath -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: target/dist/oc-rsync-*-windows-*.tar.gz

      - name: Upload Windows zip
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-zip
          path: dist/*.zip

  release-artifacts:
    name: create GitHub Release and upload assets
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/**/oc-rsync-*-windows-*.tar.gz
            dist/**/oc-rsync-*-darwin-*.tar.gz
            dist/**/oc-rsync-*-linux-*.tar.gz
            dist/**/oc-rsync_*_amd64.deb
            dist/**/oc-rsync_*_arm64.deb
            dist/**/oc-rsync-*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  brew-formula:
    name: update Homebrew formula
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF##*/}"
          printf 'tag=%s\n' "${TAG}" >> "${GITHUB_OUTPUT}"

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-macos
          path: dist-macos

      - name: Generate Homebrew formula
        shell: bash
        env:
          FORMULA_PATH: Formula/oc-rsync.rb
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${TAG#v}"
          REPO="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"

          mkdir -p Formula

          # Find actual macOS tarballs from artifacts (accepts both x86_64/amd64 and aarch64/arm64)
          AMD64_PATH="$(find dist-macos -maxdepth 1 -type f \( -name 'oc-rsync-*darwin*x86_64*.tar.gz' -o -name 'oc-rsync-*darwin*amd64*.tar.gz' \) | sort | head -n1 || true)"
          ARM64_PATH="$(find dist-macos -maxdepth 1 -type f \( -name 'oc-rsync-*darwin*aarch64*.tar.gz' -o -name 'oc-rsync-*darwin*arm64*.tar.gz' \) | sort | head -n1 || true)"

          if [ -z "${AMD64_PATH}" ] || [ -z "${ARM64_PATH}" ]; then
            printf 'Could not locate both macOS amd64 and arm64 tarballs in dist-macos\n' >&2
            ls -R dist-macos || true
            exit 1
          fi

          AMD64_TARBALL="$(basename "${AMD64_PATH}")"
          ARM64_TARBALL="$(basename "${ARM64_PATH}")"

          AMD64_SHA256="$(shasum -a 256 "${AMD64_PATH}" | awk '{print $1}')"
          ARM64_SHA256="$(shasum -a 256 "${ARM64_PATH}" | awk '{print $1}')"

          {
            echo "class OcRsync < Formula"
            echo '  desc "Pure-Rust rsync 3.4.1-compatible implementation"'
            echo '  homepage "https://github.com/oferchen/rsync"'
            echo '  license "GPL-3.0-or-later"'
            echo "  version \"${VERSION}\""
            echo
            echo "  on_macos do"
            echo "    on_intel do"
            echo "      url \"${REPO}/${AMD64_TARBALL}\""
            echo "      sha256 \"${AMD64_SHA256}\""
            echo "    end"
            echo
            echo "    on_arm do"
            echo "      url \"${REPO}/${ARM64_TARBALL}\""
            echo "      sha256 \"${ARM64_SHA256}\""
            echo "    end"
            echo "  end"
            echo
            echo "  def install"
            echo "    bin.install \"bin/oc-rsync\""
            echo "  end"
            echo
            echo "  test do"
            echo "    system \"#{bin}/oc-rsync\", \"--version\""
            echo "  end"
            echo "end"
          } > "${FORMULA_PATH}"

          printf 'Formula generated at %s\n' "${FORMULA_PATH}"

      - name: Commit and push formula branch
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          BRANCH="ci/brew-formula-${TAG}"

          git config user.name "oc-rsync-bot"
          git config user.email "actions@github.com"

          # Fetch master and create branch from FETCH_HEAD (origin/master may not exist in shallow tag checkout)
          git fetch origin master --depth=1
          git checkout -B "${BRANCH}" FETCH_HEAD

          git add "${FORMULA_PATH}"

          if git diff --cached --quiet; then
            printf 'No changes to commit; skipping push.\n'
            exit 0
          fi

          git commit -m "chore: update Homebrew formula for ${TAG}"
          git push --force origin "${BRANCH}"

          printf 'Pushed branch %s\n' "${BRANCH}"
          printf 'Open a PR at:\n'
          printf '  https://github.com/%s/compare/master...%s?expand=1\n' "${GITHUB_REPOSITORY}" "${BRANCH}"
