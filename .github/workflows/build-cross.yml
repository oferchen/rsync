name: Build-cross

on:
  push:
    tags:
      - "v*.*.*-rust"
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  linux:
    name: linux release artifacts
    runs-on: ubuntu-24.04

    steps:
      - name: Force DNS to 8.8.8.8 (robust)
        run: |
          set -euo pipefail

          echo ">>> Inspecting current /etc/resolv.conf"
          ls -l /etc/resolv.conf || true
          cat /etc/resolv.conf || true
          echo ">>> End of original resolv.conf"

          # If resolv.conf is completely missing, create a minimal one and exit.
          if [ ! -e /etc/resolv.conf ]; then
            echo ">>> /etc/resolv.conf missing, creating minimal one"
            printf 'nameserver 8.8.8.8\n' | sudo tee /etc/resolv.conf >/dev/null
            ls -l /etc/resolv.conf
            cat /etc/resolv.conf
            exit 0
          fi

          # Backup the original (follow symlink) once per job for debugging.
          if [ ! -f /tmp/resolv.conf.original ]; then
            echo ">>> Backing up original resolv.conf to /tmp/resolv.conf.original"
            sudo cp -L /etc/resolv.conf /tmp/resolv.conf.original || true
          fi

          tmp="$(mktemp)"
          trap 'sudo rm -f "$tmp" >/dev/null 2>&1 || true' EXIT

          # Always work on a plain file, even if /etc/resolv.conf is a symlink
          sudo cp -L /etc/resolv.conf "$tmp"

          # Build a new resolv.conf:
          #   - First line is always: nameserver 8.8.8.8
          #   - Then all existing non-empty, non-comment lines
          #     excluding any existing 8.8.8.8 nameserver (to avoid duplicates).
          {
            printf 'nameserver 8.8.8.8\n'
            sudo sed -E '
              /^[[:space:]]*$/d;                                       # drop empty
              /^[[:space:]]*#/d;                                       # drop comments
              /^[[:space:]]*nameserver[[:space:]]+8\.8\.8\.8([[:space:]]|$)/d;
            ' "$tmp"
          } | sudo tee /etc/resolv.conf >/dev/null

          echo ">>> Effective /etc/resolv.conf after override"
          ls -l /etc/resolv.conf
          cat /etc/resolv.conf

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-linux

      - name: Install system dependencies
        run: |
          set -euo pipefail
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libacl1-dev \
            libattr1-dev \
            libzstd-dev \
            zlib1g-dev \
            libxxhash-dev \
            gcc-aarch64-linux-gnu \
            libssl-dev:arm64 \
            libacl1-dev:arm64 \
            libattr1-dev:arm64 \
            libzstd-dev:arm64 \
            zlib1g-dev:arm64 \
            libxxhash-dev:arm64

      - name: Build Linux x86_64 packages
        run: cargo xtask package --deb --rpm --tarball --tarball-target x86_64-unknown-linux-gnu --release

      - name: Build Linux aarch64 tarball
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
        run: cargo xtask package --tarball --tarball-target aarch64-unknown-linux-gnu --release

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            target/dist/oc-rsync-*-linux-*.tar.gz
            target/debian/*.deb
            target/generate-rpm/*.rpm

  macos:
    name: macOS release artifacts
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-macos

      - name: Install OpenSSL
        run: |
          brew update
          brew install openssl@3 || true
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Build macOS aarch64 tarball
        run: cargo xtask package --tarball --tarball-target aarch64-apple-darwin --release

      - name: Build macOS x86_64 tarball
        run: cargo xtask package --tarball --tarball-target x86_64-apple-darwin --release

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: target/dist/oc-rsync-*-darwin-*.tar.gz

  windows:
    name: windows release artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-windows

      # - name: Disable rustc wrapper if configured
      #   shell: pwsh
      #   run: |
      #     New-Item -ItemType Directory -Force -Path .cargo | Out-Null
      #     Set-Content -Path .cargo/config.toml -Encoding UTF8 -Value "[build]"
      #     Add-Content -Path .cargo/config.toml -Encoding UTF8 -Value 'rustc-wrapper = ""'
      #     Remove-Item Env:CARGO_BUILD_RUSTC_WRAPPER -ErrorAction SilentlyContinue
      #     Remove-Item Env:RUSTC_WRAPPER -ErrorAction SilentlyContinue

      - name: Disable rustc wrapper if configured
        shell: pwsh
        run: |
          $configPath = ".cargo/config.toml"
      
          # 1) Keep existing config, only remove rustc-wrapper lines
          if (Test-Path $configPath) {
            $content = Get-Content -Path $configPath -Encoding UTF8
      
            # drop any rustc-wrapper = ... line
            $filtered = $content | Where-Object { $_ -notmatch '^\s*rustc-wrapper\s*=' }
      
            $filtered | Set-Content -Path $configPath -Encoding UTF8
          }
      
          # 2) Explicitly override in the job environment using GitHub Actions convention
          "RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_BUILD_RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Windows tarball
        shell: pwsh
        run: |
          $env:OC_RSYNC_PACKAGE_DEFAULT_FEATURES = "0"
          $env:OC_RSYNC_PACKAGE_FEATURES = "zstd lz4 iconv"
          cargo xtask package --tarball --tarball-target x86_64-pc-windows-msvc --release

      - name: Create Windows zip archive
        shell: pwsh
        run: |
          $distDir = Join-Path (Get-Location) "dist"
          if (-not (Test-Path $distDir)) {
            New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          }
          $tarball = Get-ChildItem -Path (Join-Path (Get-Location) "target\dist") -Filter "oc-rsync-*-windows-*.tar.gz" | Select-Object -First 1
          if ($null -eq $tarball) {
            throw "expected windows tarball to exist"
          }
          $profileDir = Join-Path (Get-Location) "target\x86_64-pc-windows-msvc\dist"
          $binaries = Get-ChildItem -Path $profileDir -Filter "*.exe" | Where-Object { $_.Name -match '^(oc-rsync|rsync)' }
          if ($binaries.Count -eq 0) {
            throw "no Windows binaries found for zip packaging"
          }
          $zipPath = Join-Path $distDir ($tarball.BaseName + ".zip")
          Compress-Archive -Path $binaries.FullName -DestinationPath $zipPath -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: target/dist/oc-rsync-*-windows-*.tar.gz

      - name: Upload Windows zip
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-zip
          path: dist/*.zip
