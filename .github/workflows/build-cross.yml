name: Build-cross

on:
  push:
    tags:
      - "v*.*.*-rust"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUST_BACKTRACE: "full"
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  linux:
    name: linux release artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-linux

      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail

          # Enable arm64 multiarch
          sudo dpkg --add-architecture arm64

          # Discover codename (e.g. noble)
          . /etc/os-release
          codename="${UBUNTU_CODENAME:-${VERSION_CODENAME}}"
          echo "Ubuntu codename: ${codename}"

          # If deb822 ubuntu.sources exists (24.04+), make it amd64-only
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sudo awk '
              BEGIN { in_stanza = 0; had_arch = 0 }
              /^Types:/ { in_stanza = 1; had_arch = 0 }
              /^$/     { in_stanza = 0; had_arch = 0 }
              /^Architectures:/ { had_arch = 1 }
              {
                print
                if (in_stanza && /^Components:/ && !had_arch) {
                  print "Architectures: amd64"
                  had_arch = 1
                }
              }
            ' /etc/apt/sources.list.d/ubuntu.sources \
              | sudo tee /etc/apt/sources.list.d/ubuntu.sources.new >/dev/null
            sudo mv /etc/apt/sources.list.d/ubuntu.sources.new /etc/apt/sources.list.d/ubuntu.sources
          fi

          # Add ports.ubuntu.com for arm64
          sudo sh -c '
            codename="$1"
            {
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s %s-updates %s-backports\n" "$codename" "$codename" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
              printf "\n"
              printf "Types: deb\n"
              printf "URIs: http://ports.ubuntu.com/ubuntu-ports/\n"
              printf "Suites: %s-security\n" "$codename"
              printf "Components: main restricted universe multiverse\n"
              printf "Architectures: arm64\n"
              printf "Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n"
            } > /etc/apt/sources.list.d/ubuntu-ports-arm64.sources
          ' sh "$codename"

          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get -y install \
            pkg-config \
            libssl-dev \
            libacl1-dev \
            libattr1-dev \
            libzstd-dev \
            zlib1g-dev \
            libxxhash-dev \
            gcc-aarch64-linux-gnu \
            libssl-dev:arm64 \
            libacl1-dev:arm64 \
            libattr1-dev:arm64 \
            libzstd-dev:arm64 \
            zlib1g-dev:arm64 \
            libxxhash-dev:arm64

      - name: Install cargo-deb and cargo-rpm
        shell: bash
        run: |
          set -euo pipefail

          # cargo is already on PATH from the toolchain action; just ensure the subcommands exist
          if ! command -v cargo-deb >/dev/null 2>&1; then
            cargo install --locked cargo-deb
          fi

          if ! command -v cargo-rpm >/dev/null 2>&1; then
            cargo install --locked cargo-rpm
          fi

      - name: Build Linux packages (deb + tarball, try RPM)
        shell: bash
        run: |
          set -euo pipefail

          echo "Running cargo xtask package with RPM..."
          if cargo xtask package \
              --deb \
              --rpm \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --release
          then
            echo "cargo xtask package (with RPM) completed successfully."
          else
            echo "cargo xtask package failed (likely during RPM build)."
            echo "Falling back to packaging without RPM..."
            cargo xtask package \
              --deb \
              --tarball \
              --tarball-target x86_64-unknown-linux-gnu \
              --release
          fi

      - name: Build Linux aarch64 tarball
        shell: bash
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig
        run: |
          set -euo pipefail
          cargo xtask package \
            --tarball \
            --tarball-target aarch64-unknown-linux-gnu \
            --release

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            target/dist/oc-rsync-*-linux-*.tar.gz
            target/debian/*.deb
            target/**/*.rpm

  macos:
    name: macOS release artifacts
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-macos

      - name: Install OpenSSL
        run: |
          brew update
          brew install openssl@3 || true
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Build macOS aarch64 tarball
        run: cargo xtask package --tarball --tarball-target aarch64-apple-darwin --release

      - name: Build macOS x86_64 tarball
        run: cargo xtask package --tarball --tarball-target x86_64-apple-darwin --release

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: target/dist/oc-rsync-*-darwin-*.tar.gz

  windows:
    name: windows release artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          key: build-windows

      - name: Disable rustc wrapper if configured
        shell: pwsh
        run: |
          $configPath = ".cargo/config.toml"
          if (Test-Path $configPath) {
            $content = Get-Content -Path $configPath -Encoding UTF8
            $filtered = $content | Where-Object { $_ -notmatch '^\s*rustc-wrapper\s*=' }
            $filtered | Set-Content -Path $configPath -Encoding UTF8
          }
          "RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_BUILD_RUSTC_WRAPPER=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Windows tarball
        shell: pwsh
        run: |
          $env:OC_RSYNC_PACKAGE_DEFAULT_FEATURES = "0"
          $env:OC_RSYNC_PACKAGE_FEATURES = "zstd lz4 iconv"
          cargo xtask package --tarball --tarball-target x86_64-pc-windows-msvc --release

      - name: Create Windows zip archive
        shell: pwsh
        run: |
          $distDir = Join-Path (Get-Location) "dist"
          if (-not (Test-Path $distDir)) {
            New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          }
          $tarball = Get-ChildItem -Path (Join-Path (Get-Location) "target\dist") -Filter "oc-rsync-*-windows-*.tar.gz" | Select-Object -First 1
          if ($null -eq $tarball) {
            throw "expected windows tarball to exist"
          }
          $profileDir = Join-Path (Get-Location) "target\x86_64-pc-windows-msvc\dist"
          $binaries = Get-ChildItem -Path $profileDir -Filter "*.exe" | Where-Object { $_.Name -match '^(oc-rsync|rsync)' }
          if ($binaries.Count -eq 0) {
            throw "no Windows binaries found for zip packaging"
          }
          $zipPath = Join-Path $distDir ($tarball.BaseName + ".zip")
          Compress-Archive -Path $binaries.FullName -DestinationPath $zipPath -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: target/dist/oc-rsync-*-windows-*.tar.gz

      - name: Upload Windows zip
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-zip
          path: dist/*.zip

  release-artifacts:
    name: create GitHub Release and upload assets
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/**/*.tar.gz
            dist/**/*.deb
            dist/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  brew-formula:
    name: update Homebrew formula
    runs-on: ubuntu-latest
    needs:
      - release-artifacts

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        run: |
          TAG="${GITHUB_REF##*/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate Homebrew formula
        shell: bash
        env:
          FORMULA_PATH: Formula/oc-rsync.rb
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${TAG#v}"
          REPO="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"

          mkdir -p Formula

          WORKDIR="$(mktemp -d)"
          trap 'rm -rf "$WORKDIR"' EXIT

          amd64_candidates=(
            "oc-rsync-${VERSION}-x86_64-apple-darwin.tar.gz"
            "oc-rsync-${VERSION}-darwin-amd64.tar.gz"
            "oc-rsync-${VERSION}-darwin-x86_64.tar.gz"
            "oc-rsync-macos-amd64.tar.gz"
          )

          arm64_candidates=(
            "oc-rsync-${VERSION}-aarch64-apple-darwin.tar.gz"
            "oc-rsync-${VERSION}-darwin-arm64.tar.gz"
            "oc-rsync-${VERSION}-darwin-aarch64.tar.gz"
            "oc-rsync-macos-arm64.tar.gz"
          )

          pick_asset() {
            local os_arch="$1"
            shift
            local -a candidates=("$@")

            for name in "${candidates[@]}"; do
              local url="${REPO}/${name}"
              echo "Probing ${os_arch} candidate: ${url}" >&2
              if curl -fsIL "${url}" >/dev/null 2>&1; then
                echo "${name}"
                return 0
              fi
            done

            echo "ERROR: No matching asset found for ${os_arch} in release ${TAG}" >&2
            echo "Tried candidates:" >&2
            printf '  - %s\n' "${candidates[@]}" >&2
            exit 1
          }

          AMD64_TARBALL="$(pick_asset "macos-amd64" "${amd64_candidates[@]}")"
          ARM64_TARBALL="$(pick_asset "macos-arm64" "${arm64_candidates[@]}")"

          echo "Using macOS Intel tarball: ${AMD64_TARBALL}"
          echo "Using macOS ARM64 tarball: ${ARM64_TARBALL}"

          curl -fsSL "${REPO}/${AMD64_TARBALL}" -o "${WORKDIR}/${AMD64_TARBALL}"
          curl -fsSL "${REPO}/${ARM64_TARBALL}" -o "${WORKDIR}/${ARM64_TARBALL}"

          AMD64_SHA256="$(shasum -a 256 "${WORKDIR}/${AMD64_TARBALL}" | awk '{print $1}')"
          ARM64_SHA256="$(shasum -a 256 "${WORKDIR}/${ARM64_TARBALL}" | awk '{print $1}')"

          {
            echo "class OcRsync < Formula"
            echo '  desc "Pure-Rust rsync 3.4.1-compatible implementation"'
            echo '  homepage "https://github.com/oferchen/rsync"'
            echo '  license "GPL-3.0-or-later"'
            echo "  version \"${VERSION}\""
            echo
            echo "  on_macos do"
            echo "    on_intel do"
            echo "      url \"${REPO}/${AMD64_TARBALL}\""
            echo "      sha256 \"${AMD64_SHA256}\""
            echo "    end"
            echo
            echo "    on_arm do"
            echo "      url \"${REPO}/${ARM64_TARBALL}\""
            echo "      sha256 \"${ARM64_SHA256}\""
            echo "    end"
            echo "  end"
            echo
            echo "  def install"
            echo "    bin.install \"oc-rsync\""
            echo "    bin.install \"oc-rsyncd\""
            echo "  end"
            echo
            echo "  test do"
            echo "    system \"#{bin}/oc-rsync\", \"--version\""
            echo "  end"
            echo "end"
          } > "${FORMULA_PATH}"

          echo "Formula generated at ${FORMULA_PATH}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          title: "Update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          body: "Auto-generated from release assets."
          branch: "ci/brew-formula-${{ steps.vars.outputs.tag }}"
          base: master
