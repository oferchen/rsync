name: Benchmark

on:
  push:
    tags:
      - "v[0-9]*.[0-9]*.[0-9]*"
  workflow_dispatch:
    inputs:
      baseline_tag:
        description: 'Baseline tag/branch to compare against'
        required: false
        default: ''

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: benchmark

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool \
            libacl1-dev libattr1-dev zlib1g-dev libxxhash-dev libzstd-dev liblz4-dev

      - name: Build oc-rsync (release)
        run: cargo build --release --workspace

      - name: Cache upstream rsync
        id: cache-rsync
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: target/interop/upstream-src/rsync-3.4.1
          key: upstream-rsync-3.4.1-${{ runner.os }}-built

      - name: Build upstream rsync 3.4.1
        if: steps.cache-rsync.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          mkdir -p target/interop/upstream-src
          cd target/interop/upstream-src

          if [ ! -d rsync-3.4.1 ]; then
            curl -L https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz | tar xz
          fi

          cd rsync-3.4.1
          if [ ! -f rsync ]; then
            ./configure --disable-xxhash --disable-zstd --disable-lz4
            make -j$(nproc)
          fi

      - name: Run criterion benchmarks
        id: criterion
        run: |
          # Run internal optimization benchmarks
          cargo bench -p checksums --bench checksums_benchmark -- --noplot > /dev/null 2>&1 || true
          cargo bench -p engine --bench optimizations_benchmark -- --noplot 2>&1 | tee criterion_output.txt || true

          # Extract key metrics for buffer pool
          echo "## Internal Optimization Benchmarks" > criterion_report.md
          echo "" >> criterion_report.md
          echo "### Buffer Pool Performance" >> criterion_report.md
          echo "" >> criterion_report.md
          echo '```' >> criterion_report.md
          grep -A1 "buffer_allocation\|sequential_buffer_ops\|concurrent_buffer" criterion_output.txt | head -50 >> criterion_report.md || echo "No buffer pool benchmarks found" >> criterion_report.md
          echo '```' >> criterion_report.md

      - name: Run benchmark
        id: benchmark
        run: |
          set -euo pipefail
          python3 .github/scripts/benchmark.py > benchmark_results.json
          python3 .github/scripts/benchmark_report.py > benchmark_report.md
          cat benchmark_report.md

      - name: Upload benchmark results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: benchmark-results
          retention-days: 90
          path: |
            benchmark_results.json
            benchmark_report.md
            criterion_report.md
            criterion_output.txt

      - name: Add benchmark to release notes
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF##*/}"

          # Get current release body
          CURRENT_BODY=$(gh release view "$TAG" --json body -q .body 2>/dev/null || echo "")

          # Append benchmark reports
          CRITERION_REPORT=""
          if [ -f criterion_report.md ]; then
            CRITERION_REPORT=$(cat criterion_report.md)
          fi

          NEW_BODY="${CURRENT_BODY}

          ---

          $(cat benchmark_report.md)

          ---

          ${CRITERION_REPORT}"

          # Update release
          gh release edit "$TAG" --notes "$NEW_BODY" || echo "Could not update release notes"

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benchmark_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
