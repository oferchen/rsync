name: Release-artifacts

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  brew-formula:
    name: update Homebrew formula
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        run: |
          # For release events, tag_name is like "v3.4.1a-rust"
          TAG="${{ github.event.release.tag_name }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate Homebrew formula
        shell: bash
        env:
          FORMULA_PATH: Formula/oc-rsync.rb
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${TAG#v}"  # strip leading "v"
          REPO="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"

          mkdir -p Formula

          WORKDIR="$(mktemp -d)"
          trap 'rm -rf "$WORKDIR"' EXIT

          # Candidate filenames for macOS Intel (amd64)
          amd64_candidates=(
            "oc-rsync-${VERSION}-x86_64-apple-darwin.tar.gz"
            "oc-rsync-${VERSION}-darwin-amd64.tar.gz"
            "oc-rsync-${VERSION}-darwin-x86_64.tar.gz"
            "oc-rsync-macos-amd64.tar.gz"
          )

          # Candidate filenames for macOS ARM64
          arm64_candidates=(
            "oc-rsync-${VERSION}-aarch64-apple-darwin.tar.gz"
            "oc-rsync-${VERSION}-darwin-arm64.tar.gz"
            "oc-rsync-${VERSION}-darwin-aarch64.tar.gz"
            "oc-rsync-macos-arm64.tar.gz"
          )

          pick_asset() {
            local os_arch="$1"    # "macos-amd64" / "macos-arm64"
            shift
            local -a candidates=("$@")

            for name in "${candidates[@]}"; do
              local url="${REPO}/${name}"
              echo "Probing ${os_arch} candidate: ${url}" >&2
              if curl -fsIL "${url}" >/dev/null 2>&1; then
                echo "${name}"
                return 0
              fi
            done

            echo "ERROR: No matching asset found for ${os_arch} in release ${TAG}" >&2
            echo "Tried candidates:" >&2
            printf '  - %s\n' "${candidates[@]}" >&2
            exit 1
          }

          AMD64_TARBALL="$(pick_asset "macos-amd64" "${amd64_candidates[@]}")"
          ARM64_TARBALL="$(pick_asset "macos-arm64" "${arm64_candidates[@]}")"

          echo "Using macOS Intel tarball: ${AMD64_TARBALL}"
          echo "Using macOS ARM64 tarball: ${ARM64_TARBALL}"

          curl -fsSL "${REPO}/${AMD64_TARBALL}" -o "${WORKDIR}/${AMD64_TARBALL}"
          curl -fsSL "${REPO}/${ARM64_TARBALL}" -o "${WORKDIR}/${ARM64_TARBALL}"

          AMD64_SHA256="$(shasum -a 256 "${WORKDIR}/${AMD64_TARBALL}" | awk '{print $1}')"
          ARM64_SHA256="$(shasum -a 256 "${WORKDIR}/${ARM64_TARBALL}" | awk '{print $1}')"

          {
            echo "class OcRsync < Formula"
            echo '  desc "Pure-Rust rsync 3.4.1-compatible implementation"'
            echo '  homepage "https://github.com/oferchen/rsync"'
            echo '  license "GPL-3.0-or-later"'
            echo "  version \"${VERSION}\""
            echo
            echo "  on_macos do"
            echo "    on_intel do"
            echo "      url \"${REPO}/${AMD64_TARBALL}\""
            echo "      sha256 \"${AMD64_SHA256}\""
            echo "    end"
            echo
            echo "    on_arm do"
            echo "      url \"${REPO}/${ARM64_TARBALL}\""
            echo "      sha256 \"${ARM64_SHA256}\""
            echo "    end"
            echo "  end"
            echo
            echo "  def install"
            echo "    bin.install \"oc-rsync\""
            echo "    bin.install \"oc-rsyncd\""
            echo "  end"
            echo
            echo "  test do"
            echo "    system \"#{bin}/oc-rsync\", \"--version\""
            echo "  end"
            echo "end"
          } > "${FORMULA_PATH}"

          echo "Formula generated at ${FORMULA_PATH}"

      - name: Commit and push formula branch
        shell: bash
        env:
          BREW_TOKEN: ${{ secrets.OC_RSYNC_BREW_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          BRANCH="ci/brew-formula-${TAG}"

          # Configure git identity for the commit
          git config user.name "oc-rsync-bot"
          git config user.email "actions@github.com"

          # Repoint "origin" to use the PAT instead of GITHUB_TOKEN
          git remote set-url origin "https://x-access-token:${BREW_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Base the branch off the latest master
          git fetch origin master --depth=1
          git checkout -B "${BRANCH}" origin/master

          git add "${FORMULA_PATH}"

          if git diff --cached --quiet; then
            echo "No changes to commit; skipping push."
            exit 0
          fi

          git commit -m "chore: update Homebrew formula for ${TAG}"
          git push --force-with-lease origin "${BRANCH}"

          echo "Pushed branch ${BRANCH}"
          echo "Open a PR at:"
          echo "  https://github.com/${GITHUB_REPOSITORY}/compare/master...${BRANCH}?expand=1"
