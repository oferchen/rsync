name: brew-formula

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  pull-requests: write

env:
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  update-brew:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        run: |
          TAG="${GITHUB_REF##*/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate formula
        run: |
          VERSION="${{ steps.vars.outputs.tag }}"
          mkdir -p Formula
          cat > "${FORMULA_PATH}" <<EOF
class OcRsync < Formula
  desc "Pure-Rust rsync 3.4.1-compatible implementation"
  homepage "https://github.com/oferchen/rsync"
  version "${VERSION}"
  url "https://github.com/oferchen/rsync/releases/download/${VERSION}/oc-rsync-macos-amd64.tar.gz"
  sha256 "CHANGE_ME"
  license "GPL-3.0-or-later"

  def install
    bin.install "oc-rsync"
    bin.install "oc-rsyncd"
  end

  test do
    system "#{bin}/oc-rsync", "--version"
  end
end
EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          title: "Update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          body: "Auto-generated from release assets."
          branch: "ci/brew-formula-${{ steps.vars.outputs.tag }}"
          base: master
