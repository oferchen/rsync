name: Brew-formula

on:
  # Manual trigger is still allowed
  workflow_dispatch:

  # Run automatically after the Release-artifacts workflow completes
  workflow_run:
    workflows: ["Release-artifacts"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

env:
  FORMULA_PATH: Formula/oc-rsync.rb

jobs:
  update-brew:
    # Only run automatically if Release-artifacts succeeded
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # we need full history + tags when triggered via workflow_run
          fetch-depth: 0

      - name: Extract tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            # Manual run: assume we're on the tag ref
            TAG="${GITHUB_REF##*/}"
          else
            # Triggered from workflow_run (Release-artifacts)
            SHA="${{ github.event.workflow_run.head_sha }}"
            git fetch --tags --force

            TAGS="$(git tag --points-at "${SHA}")"
            if [ -z "${TAGS}" ]; then
              echo "::error::No tag found for commit ${SHA}" >&2
              exit 1
            fi

            TAG="$(printf '%s\n' "${TAGS}" | head -n1)"
          fi

          VERSION_NO_PREFIX="${TAG#v}"

          {
            echo "tag=${TAG}"
            echo "version_no_prefix=${VERSION_NO_PREFIX}"
          } >> "${GITHUB_OUTPUT}"

      - name: Generate Homebrew formula
        shell: bash
        env:
          FORMULA_PATH: ${{ env.FORMULA_PATH }}
        run: |
          set -euo pipefail

          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${{ steps.vars.outputs.version_no_prefix }}"
          REPO="https://github.com/${{ github.repository }}/releases/download/${TAG}"

          WORKDIR="$(mktemp -d)"
          trap 'rm -rf "$WORKDIR"' EXIT

          AMD64_TARBALL="oc-rsync-${VERSION}-darwin-x86_64.tar.gz"
          ARM64_TARBALL="oc-rsync-${VERSION}-darwin-aarch64.tar.gz"

          curl -fsSL "${REPO}/${AMD64_TARBALL}" -o "${WORKDIR}/${AMD64_TARBALL}"
          curl -fsSL "${REPO}/${ARM64_TARBALL}" -o "${WORKDIR}/${ARM64_TARBALL}"

          AMD64_SHA256="$(shasum -a 256 "${WORKDIR}/${AMD64_TARBALL}" | awk '{print $1}')"
          ARM64_SHA256="$(shasum -a 256 "${WORKDIR}/${ARM64_TARBALL}" | awk '{print $1}')"

          mkdir -p "$(dirname "${FORMULA_PATH}")"

          {
            echo "class OcRsync < Formula"
            echo '  desc "Pure-Rust rsync 3.4.1-compatible implementation"'
            echo '  homepage "https://github.com/oferchen/rsync"'
            echo '  license "GPL-3.0-or-later"'
            echo "  version \"${VERSION}\""
            echo
            echo "  on_macos do"
            echo "    on_intel do"
            echo "      url \"${REPO}/${AMD64_TARBALL}\""
            echo "      sha256 \"${AMD64_SHA256}\""
            echo "    end"
            echo
            echo "    on_arm do"
            echo "      url \"${REPO}/${ARM64_TARBALL}\""
            echo "      sha256 \"${ARM64_SHA256}\""
            echo "    end"
            echo "  end"
            echo
            echo "  def install"
            echo "    bin.install \"oc-rsync\""
            echo "  end"
            echo
            echo "  test do"
            echo "    system \"#{bin}/oc-rsync\", \"--version\""
            echo "  end"
            echo "end"
          } > "${FORMULA_PATH}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          title: "Update Homebrew formula for ${{ steps.vars.outputs.tag }}"
          body: "Auto-generated from release assets."
          branch: "ci/brew-formula-${{ steps.vars.outputs.tag }}"
          base: master
