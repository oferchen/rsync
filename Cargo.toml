[package]
name = "oc-rsync"
version = "3.4.1-rust"
edition = "2024"
rust-version = "1.88"
authors = ["Ofer Chen <skewers.irises.3b@icloud.com>"]
license = "GPL-3.0-or-later"
description = "Pure-Rust implementation of the rsync client and daemon binaries (with oc-rsync compatibility wrappers)"
repository = "https://github.com/oferchen/rsync"
publish = true
autobins = false

[[bin]]
name = "rsync"
path = "src/bin/rsync.rs"
required-features = ["legacy-binaries"]

[[bin]]
name = "rsyncd"
path = "src/bin/rsyncd.rs"
required-features = ["legacy-binaries"]

[[bin]]
name = "oc-rsync"
path = "src/bin/oc-rsync.rs"

[[bin]]
name = "oc-rsyncd"
path = "src/bin/oc-rsyncd.rs"

[features]
default = []
legacy-binaries = []
sd-notify = ["rsync-daemon/sd-notify"]

[dependencies]
rsync-cli = { path = "crates/cli" }
rsync-daemon = { path = "crates/daemon" }

[dev-dependencies]
assert_cmd = "2.0"
rsync-core = { path = "crates/core" }

[target.'cfg(all(windows, target_env = "gnu"))'.dependencies]
rsync-windows-gnu-eh = { path = "crates/windows-gnu-eh" }

[workspace]
members = [
    "crates/cli",
    "crates/bandwidth",
    "crates/checksums",
    "crates/core",
    "crates/daemon",
    "crates/engine",
    "crates/filters",
    "crates/logging",
    "crates/compress",
    "crates/meta",
    "crates/protocol",
    "crates/walk",
    "crates/transport",
    "crates/windows-gnu-eh",
    "xtask",
    "crates/apple-fs",
]
resolver = "2"

[workspace.package]
edition = "2024"
rust-version = "1.88"
authors = ["Ofer Chen <skewers.irises.3b@icloud.com>"]
license = "GPL-3.0-or-later"
version = "3.4.1-rust"

[workspace.metadata.docs.rs]
all-features = true
no-default-features = false
rustdoc-args = ["--cfg", "docsrs", "-D", "rustdoc::broken_intra_doc_links"]
targets = ["x86_64-unknown-linux-gnu"]

[workspace.metadata.oc_rsync]
brand = "oc"
upstream_version = "3.4.1"
rust_version = "3.4.1-rust"
protocol = 32
client_bin = "oc-rsync"
daemon_bin = "oc-rsyncd"
legacy_client_bin = "rsync"
legacy_daemon_bin = "rsyncd"
daemon_config_dir = "/etc/oc-rsyncd"
daemon_config = "/etc/oc-rsyncd/oc-rsyncd.conf"
daemon_secrets = "/etc/oc-rsyncd/oc-rsyncd.secrets"
legacy_daemon_config_dir = "/etc"
legacy_daemon_config = "/etc/rsyncd.conf"
legacy_daemon_secrets = "/etc/rsyncd.secrets"
source = "https://github.com/oferchen/rsync"

[workspace.metadata.oc_rsync.cross_compile]
linux = ["x86_64", "aarch64"]
macos = ["x86_64", "aarch64"]
windows = ["x86_64", "aarch64"]

[workspace.metadata.oc_rsync.cross_compile_matrix]
"linux-x86_64" = true
"linux-aarch64" = true
"darwin-x86_64" = true
"darwin-aarch64" = true
"windows-x86_64" = false
"windows-aarch64" = false
"windows-x86" = false

[package.metadata.deb]
name = "oc-rsync"
section = "utils"
priority = "optional"
maintainer = "Ofer Chen <skewers.irises.3b@icloud.com>"
depends = "libc6 (>= 2.34), libgcc-s1"
extended-description = "Pure-Rust implementation of rsync-compatible client and daemon binaries. Ships oc-rsync compatibility wrappers for environments that still rely on the legacy branding."
features = ["legacy-binaries"]
conflicts = []
replaces = []

assets = [
    ["target/dist/oc-rsync", "usr/bin/oc-rsync", "755"],
    ["target/dist/oc-rsyncd", "usr/bin/oc-rsyncd", "755"],
    ["target/dist/rsync", "usr/libexec/oc-rsync/rsync", "755"],
    ["target/dist/rsyncd", "usr/libexec/oc-rsync/rsyncd", "755"],
    ["LICENSE", "usr/share/doc/oc-rsync/LICENSE", "644"],
    ["packaging/systemd/oc-rsyncd.service", "/lib/systemd/system/oc-rsyncd.service", "644"],
    ["packaging/etc/oc-rsyncd/oc-rsyncd.conf", "/etc/oc-rsyncd/oc-rsyncd.conf", "644"],
    ["packaging/etc/oc-rsyncd/oc-rsyncd.secrets", "/etc/oc-rsyncd/oc-rsyncd.secrets", "600"],
    ["packaging/default/oc-rsyncd", "/etc/default/oc-rsyncd", "644"],
]
conf-files = [
    "etc/oc-rsyncd/oc-rsyncd.conf",
    "etc/oc-rsyncd/oc-rsyncd.secrets",
    "etc/default/oc-rsyncd",
]
maintainer-scripts = "packaging/deb"

[package.metadata.rpm]
package = "oc-rsync"
summary = "Rust implementation of rsync-compatible client and daemon (includes oc-rsync compatibility wrappers)"
assets = [
    { source = "target/dist/oc-rsync", dest = "/usr/bin/oc-rsync", mode = "0755" },
    { source = "target/dist/oc-rsyncd", dest = "/usr/bin/oc-rsyncd", mode = "0755" },
    { source = "target/dist/rsync", dest = "/usr/libexec/oc-rsync/rsync", mode = "0755" },
    { source = "target/dist/rsyncd", dest = "/usr/libexec/oc-rsync/rsyncd", mode = "0755" },
    { source = "packaging/systemd/oc-rsyncd.service", dest = "/usr/lib/systemd/system/oc-rsyncd.service", mode = "0644" },
    { source = "packaging/etc/oc-rsyncd/oc-rsyncd.conf", dest = "/etc/oc-rsyncd/oc-rsyncd.conf", mode = "0644", config = true },
    { source = "packaging/etc/oc-rsyncd/oc-rsyncd.secrets", dest = "/etc/oc-rsyncd/oc-rsyncd.secrets", mode = "0600", config = true },
    { source = "packaging/default/oc-rsyncd", dest = "/etc/default/oc-rsyncd", mode = "0644", config = true },
]

[package.metadata.rpm.files."../packaging/systemd/oc-rsyncd.service"]
path = "/usr/lib/systemd/system/oc-rsyncd.service"
mode = "0644"

[package.metadata.rpm.files."../packaging/etc/oc-rsyncd/oc-rsyncd.conf"]
path = "/etc/oc-rsyncd/oc-rsyncd.conf"
mode = "0644"

[package.metadata.rpm.files."../packaging/etc/oc-rsyncd/oc-rsyncd.secrets"]
path = "/etc/oc-rsyncd/oc-rsyncd.secrets"
mode = "0600"

[package.metadata.rpm.files."../packaging/default/oc-rsyncd"]
path = "/etc/default/oc-rsyncd"
mode = "0644"


[package.metadata.rpm.scripts]
post = '''
set -e

ALT_NAME=rsync
ALT_MASTER=/usr/bin/rsync
ALT_IMPL=/usr/libexec/oc-rsync/rsync
ALT_SLAVE_NAME=rsyncd
ALT_SLAVE_LINK=/usr/bin/rsyncd
ALT_SLAVE_IMPL=/usr/libexec/oc-rsync/rsyncd
ALT_PRIORITY=30
DEFAULTS_FILE=/etc/default/oc-rsyncd

is_truthy() {
    case "$1" in
        [Yy][Ee][Ss]|[Tt][Rr][Uu][Ee]|1)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

should_register_alternatives() {
    if is_truthy "${OC_RSYNC_PACKAGE_DISABLE_ALTERNATIVES:-}"; then
        return 1
    fi

    if [ -n "${OC_RSYNC_PACKAGE_REGISTER_ALTERNATIVES:-}" ]; then
        if is_truthy "${OC_RSYNC_PACKAGE_REGISTER_ALTERNATIVES}"; then
            return 0
        fi
        return 1
    fi

    if [ -r "${DEFAULTS_FILE}" ]; then
        . "${DEFAULTS_FILE}"
    fi

    if is_truthy "${OC_RSYNC_REGISTER_ALTERNATIVES:-}"; then
        return 0
    fi

    return 1
}

detect_alternatives() {
    if command -v update-alternatives >/dev/null 2>&1; then
        ALT_TOOL=update-alternatives
    elif command -v alternatives >/dev/null 2>&1; then
        ALT_TOOL=alternatives
    else
        ALT_TOOL=
    fi
}

register_alternatives() {
    if ! should_register_alternatives; then
        return 0
    fi

    detect_alternatives
    if [ -z "$ALT_TOOL" ]; then
        return 0
    fi

    if [ -e "$ALT_MASTER" ] && [ ! -L "$ALT_MASTER" ]; then
        if ! "$ALT_TOOL" --display "$ALT_NAME" >/dev/null 2>&1; then
            return 0
        fi
    fi

    "$ALT_TOOL" --install "$ALT_MASTER" "$ALT_NAME" "$ALT_IMPL" "$ALT_PRIORITY" --slave "$ALT_SLAVE_LINK" "$ALT_SLAVE_NAME" "$ALT_SLAVE_IMPL" >/dev/null
}

register_alternatives
'''
preun = '''
set -e

ALT_NAME=rsync
ALT_MASTER=/usr/bin/rsync
ALT_IMPL=/usr/libexec/oc-rsync/rsync
ALT_SLAVE_NAME=rsyncd
ALT_SLAVE_LINK=/usr/bin/rsyncd
ALT_SLAVE_IMPL=/usr/libexec/oc-rsync/rsyncd

detect_alternatives() {
    if command -v update-alternatives >/dev/null 2>&1; then
        ALT_TOOL=update-alternatives
    elif command -v alternatives >/dev/null 2>&1; then
        ALT_TOOL=alternatives
    else
        ALT_TOOL=
    fi
}

remove_alternatives() {
    detect_alternatives
    if [ -z "$ALT_TOOL" ]; then
        return 0
    fi

    if "$ALT_TOOL" --display "$ALT_NAME" >/dev/null 2>&1; then
        "$ALT_TOOL" --remove "$ALT_NAME" "$ALT_IMPL" >/dev/null || true
    fi
}

if [ "$1" -eq 0 ]; then
    remove_alternatives
fi
'''
postun = '''
set -e

ALT_NAME=rsync
ALT_MASTER=/usr/bin/rsync
ALT_IMPL=/usr/libexec/oc-rsync/rsync
ALT_SLAVE_NAME=rsyncd
ALT_SLAVE_LINK=/usr/bin/rsyncd
ALT_SLAVE_IMPL=/usr/libexec/oc-rsync/rsyncd

detect_alternatives() {
    if command -v update-alternatives >/dev/null 2>&1; then
        ALT_TOOL=update-alternatives
    elif command -v alternatives >/dev/null 2>&1; then
        ALT_TOOL=alternatives
    else
        ALT_TOOL=
    fi
}

remove_alternatives() {
    detect_alternatives
    if [ -z "$ALT_TOOL" ]; then
        return 0
    fi

    if "$ALT_TOOL" --display "$ALT_NAME" >/dev/null 2>&1; then
        "$ALT_TOOL" --remove "$ALT_NAME" "$ALT_IMPL" >/dev/null || true
    fi
}

if [ "$1" -eq 0 ]; then
    remove_alternatives
fi
'''

[package.metadata.rpm.cargo]
profile = "dist"
buildflags = ["--profile", "dist", "--bins", "--features", "legacy-binaries"]

[package.metadata.rpm.targets]
"oc-rsync" = { path = "/usr/bin/oc-rsync", mode = "0755" }
"oc-rsyncd" = { path = "/usr/bin/oc-rsyncd", mode = "0755" }
"rsync" = { path = "/usr/libexec/oc-rsync/rsync", mode = "0755" }
"rsyncd" = { path = "/usr/libexec/oc-rsync/rsyncd", mode = "0755" }

[profile.dist]
inherits = "release"
lto = "thin"
codegen-units = 1
strip = "debuginfo"
