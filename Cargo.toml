[package]
name = "oc-rsync"
version = "3.4.1-rust"
edition = "2024"
rust-version = "1.87"
authors = ["Ofer Chen <skewers.irises.3b@icloud.com>"]
license = "GPL-3.0-or-later"
description = "Pure-Rust implementation of the rsync client and daemon binaries (with oc-rsync compatibility wrappers)"
publish = false
autobins = false

[[bin]]
name = "rsync"
path = "src/bin/rsync.rs"

[[bin]]
name = "rsyncd"
path = "src/bin/rsyncd.rs"

[[bin]]
name = "oc-rsync"
path = "src/bin/oc-rsync.rs"

[[bin]]
name = "oc-rsyncd"
path = "src/bin/oc-rsyncd.rs"

[features]
default = []
sd-notify = ["rsync-daemon/sd-notify"]

[dependencies]
rsync-cli = { path = "crates/cli" }
rsync-daemon = { path = "crates/daemon" }

[dev-dependencies]
assert_cmd = "2.0"
rsync-core = { path = "crates/core" }

[target.'cfg(all(windows, target_env = "gnu"))'.dependencies]
rsync-windows-gnu-eh = { path = "crates/windows-gnu-eh" }

[workspace]
members = [
    "crates/cli",
    "crates/bandwidth",
    "crates/checksums",
    "crates/core",
    "crates/daemon",
    "crates/engine",
    "crates/filters",
    "crates/logging",
    "crates/compress",
    "crates/meta",
    "crates/protocol",
    "crates/walk",
    "crates/transport",
    "crates/windows-gnu-eh",
    "xtask",
    "crates/apple-fs",
]
resolver = "2"

[workspace.package]
edition = "2024"
rust-version = "1.87"
authors = ["Ofer Chen <skewers.irises.3b@icloud.com>"]
license = "GPL-3.0-or-later"
version = "3.4.1-rust"

[workspace.metadata.docs.rs]
all-features = true
no-default-features = false
rustdoc-args = ["--cfg", "docsrs", "-D", "rustdoc::broken_intra_doc_links"]
targets = ["x86_64-unknown-linux-gnu"]

[workspace.metadata.oc_rsync]
brand = "oc"
upstream_version = "3.4.1"
rust_version = "3.4.1-rust"
protocol = 32
client_bin = "oc-rsync"
daemon_bin = "oc-rsyncd"
legacy_client_bin = "rsync"
legacy_daemon_bin = "rsyncd"
daemon_config_dir = "/etc/oc-rsyncd"
daemon_config = "/etc/oc-rsyncd/oc-rsyncd.conf"
daemon_secrets = "/etc/oc-rsyncd/oc-rsyncd.secrets"
legacy_daemon_config_dir = "/etc"
legacy_daemon_config = "/etc/rsyncd.conf"
legacy_daemon_secrets = "/etc/rsyncd.secrets"
source = "https://github.com/oferchen/rsync"

[workspace.metadata.oc_rsync.cross_compile]
linux = ["x86_64", "aarch64"]
macos = ["x86_64", "aarch64"]
windows = ["x86_64"]

[package.metadata.deb]
name = "oc-rsync"
section = "utils"
priority = "optional"
maintainer = "Ofer Chen <skewers.irises.3b@icloud.com>"
depends = "libc6 (>= 2.34), libgcc-s1"
extended-description = "Pure-Rust implementation of rsync-compatible client and daemon binaries. Ships oc-rsync compatibility wrappers for environments that still rely on the legacy branding."
assets = [
    ["target/release/rsync", "/usr/libexec/oc-rsync/rsync", "755"],
    ["target/release/rsyncd", "/usr/libexec/oc-rsync/rsyncd", "755"],
    ["target/release/oc-rsync", "/usr/bin/oc-rsync", "755"],
    ["target/release/oc-rsyncd", "/usr/bin/oc-rsyncd", "755"],
    ["packaging/systemd/oc-rsyncd.service", "/lib/systemd/system/oc-rsyncd.service", "644"],
    ["packaging/etc/oc-rsyncd/oc-rsyncd.conf", "/etc/oc-rsyncd/oc-rsyncd.conf", "644"],
    ["packaging/etc/oc-rsyncd/oc-rsyncd.secrets", "/etc/oc-rsyncd/oc-rsyncd.secrets", "600"],
    ["packaging/default/oc-rsyncd", "/etc/default/oc-rsyncd", "644"],
]
conf-files = [
    "etc/oc-rsyncd/oc-rsyncd.conf",
    "etc/oc-rsyncd/oc-rsyncd.secrets",
    "etc/default/oc-rsyncd",
]
maintainer-scripts = "packaging/deb"

[package.metadata.rpm]
package = "oc-rsync"
summary = "Rust implementation of rsync-compatible client and daemon (includes oc-rsync compatibility wrappers)"

[package.metadata.rpm.files."../packaging/systemd/oc-rsyncd.service"]
path = "/usr/lib/systemd/system/oc-rsyncd.service"
mode = "0644"

[package.metadata.rpm.files."../packaging/etc/oc-rsyncd/oc-rsyncd.conf"]
path = "/etc/oc-rsyncd/oc-rsyncd.conf"
mode = "0644"

[package.metadata.rpm.files."../packaging/etc/oc-rsyncd/oc-rsyncd.secrets"]
path = "/etc/oc-rsyncd/oc-rsyncd.secrets"
mode = "0600"

[package.metadata.rpm.files."../packaging/default/oc-rsyncd"]
path = "/etc/default/oc-rsyncd"
mode = "0644"

[package.metadata.rpm.cargo]
buildflags = ["--release"]

[package.metadata.rpm.targets]
rsync = { path = "/usr/libexec/oc-rsync/rsync", mode = "0755" }
rsyncd = { path = "/usr/libexec/oc-rsync/rsyncd", mode = "0755" }
"oc-rsync" = { path = "/usr/bin/oc-rsync", mode = "0755" }
"oc-rsyncd" = { path = "/usr/bin/oc-rsyncd", mode = "0755" }

[package.metadata.rpm.scripts]
post = """
if command -v alternatives >/dev/null 2>&1; then
    alternatives --install /usr/bin/rsync rsync /usr/libexec/oc-rsync/rsync 50
    alternatives --install /usr/bin/rsyncd rsyncd /usr/libexec/oc-rsync/rsyncd 50
fi
"""
preun = """
if [ "$1" -eq 0 ] && command -v alternatives >/dev/null 2>&1; then
    alternatives --remove rsync /usr/libexec/oc-rsync/rsync || true
    alternatives --remove rsyncd /usr/libexec/oc-rsync/rsyncd || true
fi
"""

